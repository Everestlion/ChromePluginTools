Diigo={Text:{},Doodle:{},UndoRedo:{},Data:{},FPT:{},$:function(a){return document.getElementById(a)}},function(a){var b={};b.parsePathData=function(a){if(!a)return[];var b=a,c=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];b=b.replace(new RegExp(" ","g"),",");for(var d=0;d<c.length;d++)b=b.replace(new RegExp(c[d],"g"),"|"+c[d]);var e=b.split("|"),f=[],g=0,h=0;for(d=1;d<e.length;d++){var i=e[d],j=i.charAt(0);i=i.slice(1),i=i.replace(new RegExp(",-","g"),"-"),i=i.replace(new RegExp("-","g"),",-"),i=i.replace(new RegExp("e,-","g"),"e-");var k=i.split(",");k.length>0&&""===k[0]&&k.shift();for(var l=0;l<k.length;l++)k[l]=parseFloat(k[l]);for(;k.length>0&&!isNaN(k[0]);){var m,n,o,p,q,r,s,t,u,v,w=null,x=[];switch(j){case"l":g+=k.shift(),h+=k.shift(),w="L",x.push(g,h);break;case"L":g=k.shift(),h=k.shift(),x.push(g,h);break;case"m":var y=k.shift(),z=k.shift();if(g+=y,h+=z,w="M",f.length>2&&"z"===f[f.length-1].command)for(var A=f.length-2;A>=0;A--)if("M"===f[A].command){g=f[A].points[0]+y,h=f[A].points[1]+z;break}x.push(g,h),j="l";break;case"M":g=k.shift(),h=k.shift(),w="M",x.push(g,h),j="L";break;case"h":g+=k.shift(),w="L",x.push(g,h);break;case"H":g=k.shift(),w="L",x.push(g,h);break;case"v":h+=k.shift(),w="L",x.push(g,h);break;case"V":h=k.shift(),w="L",x.push(g,h);break;case"C":x.push(k.shift(),k.shift(),k.shift(),k.shift()),g=k.shift(),h=k.shift(),x.push(g,h);break;case"c":x.push(g+k.shift(),h+k.shift(),g+k.shift(),h+k.shift()),g+=k.shift(),h+=k.shift(),w="C",x.push(g,h);break;case"S":n=g,o=h,m=f[f.length-1],"C"===m.command&&(n=g+(g-m.points[2]),o=h+(h-m.points[3])),x.push(n,o,k.shift(),k.shift()),g=k.shift(),h=k.shift(),w="C",x.push(g,h);break;case"s":n=g,o=h,m=f[f.length-1],"C"===m.command&&(n=g+(g-m.points[2]),o=h+(h-m.points[3])),x.push(n,o,g+k.shift(),h+k.shift()),g+=k.shift(),h+=k.shift(),w="C",x.push(g,h);break;case"Q":x.push(k.shift(),k.shift()),g=k.shift(),h=k.shift(),x.push(g,h);break;case"q":x.push(g+k.shift(),h+k.shift()),g+=k.shift(),h+=k.shift(),w="Q",x.push(g,h);break;case"T":n=g,o=h,m=f[f.length-1],"Q"===m.command&&(n=g+(g-m.points[0]),o=h+(h-m.points[1])),g=k.shift(),h=k.shift(),w="Q",x.push(n,o,g,h);break;case"t":n=g,o=h,m=f[f.length-1],"Q"===m.command&&(n=g+(g-m.points[0]),o=h+(h-m.points[1])),g+=k.shift(),h+=k.shift(),w="Q",x.push(n,o,g,h);break;case"A":p=k.shift(),q=k.shift(),r=k.shift(),s=k.shift(),t=k.shift(),u=g,v=h,g=k.shift(),h=k.shift(),w="A",x=this.convertEndpointToCenterParameterization(u,v,g,h,s,t,p,q,r);break;case"a":p=k.shift(),q=k.shift(),r=k.shift(),s=k.shift(),t=k.shift(),u=g,v=h,g+=k.shift(),h+=k.shift(),w="A",x=this.convertEndpointToCenterParameterization(u,v,g,h,s,t,p,q,r)}f.push({command:w||j,points:x})}("z"===j||"Z"===j)&&f.push({command:"z",points:[]})}return f},b.convertEndpointToCenterParameterization=function(a,b,c,d,e,f,g,h,i){var j=i*(Math.PI/180),k=Math.cos(j)*(a-c)/2+Math.sin(j)*(b-d)/2,l=-1*Math.sin(j)*(a-c)/2+Math.cos(j)*(b-d)/2,m=k*k/(g*g)+l*l/(h*h);m>1&&(g*=Math.sqrt(m),h*=Math.sqrt(m));var n=Math.sqrt((g*g*h*h-g*g*l*l-h*h*k*k)/(g*g*l*l+h*h*k*k));e===f&&(n*=-1),isNaN(n)&&(n=0);var o=n*g*l/h,p=n*-h*k/g,q=(a+c)/2+Math.cos(j)*o-Math.sin(j)*p,r=(b+d)/2+Math.sin(j)*o+Math.cos(j)*p,s=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])},t=function(a,b){return(a[0]*b[0]+a[1]*b[1])/(s(a)*s(b))},u=function(a,b){return(a[0]*b[1]<a[1]*b[0]?-1:1)*Math.acos(t(a,b))},v=u([1,0],[(k-o)/g,(l-p)/h]),w=[(k-o)/g,(l-p)/h],x=[(-1*k-o)/g,(-1*l-p)/h],y=u(w,x);return t(w,x)<=-1&&(y=Math.PI),t(w,x)>=1&&(y=0),0===f&&y>0&&(y-=2*Math.PI),1===f&&0>y&&(y+=2*Math.PI),[q,r,g,h,v,y,j,f]};var c,d=navigator.userAgent.toLowerCase();(c=d.match(/msie ([\d.]+)/))?a.ie=c[1]:(c=d.match(/firefox\/([\d.]+)/))?a.firefox=c[1]:(c=d.match(/chrome\/([\d.]+)/))?a.chrome=c[1]:(c=d.match(/opera.([\d.]+)/))?a.opera=c[1]:(c=d.match(/version\/([\d.]+).*safari/))?a.safari=c[1]:0,(c=d.match(/trident\/.*rv:([\d.]+)/))?a.ie=c[1]:0,(c=d.match(/mac os x (\d+)[\._](\d+)/))?a.macOS=c[1]+"."+c[2]:a.winOS=!0,(c=d.match(/ipad;.+version\/(\d+\.\d+)/))?a.iPad=c[1]:0,(c=d.match(/android/))?a.android=!0:0;var e=!1;a.touchable=!1;var f=window.navigator.msPointerEnabled;a.touchEventType={start:f?"10.0"===a.ie?"MSPointerDown":"pointerdown":e?"touchstart":"mousedown",move:f?"10.0"===a.ie?"MSPointerMove":"pointermove":e?"touchmove":"mousemove",end:f?"10.0"===a.ie?"MSPointerUp":"pointerup":e?"touchend":"mouseup"},a.extend=function(b,c){for(var d in c){if(null!=b[d])throw console.trace(),a.log(d),"extend error!";b[d]=c[d]}};var g=new Image;g.src="images/cross.png",a.extend(a,{parseSVGPath:function(a){return b.parsePathData(a)},__debug__:!0,log:function(){this.__debug__&&jQuery.log.apply(this,arguments)},__IMAGE_CANVAS__:null,__IMAGE_CTX__:null,_getHelperImageCanvas:function(){return null===this.__IMAGE_CANVAS__&&(this.__IMAGE_CANVAS__=document.createElement("canvas"),this.__IMAGE_CTX__=this.__IMAGE_CANVAS__.getContext("2d")),this.__IMAGE_CANVAS__},getListCursor:function(b){a._getHelperImageCanvas();var c=this.__IMAGE_CANVAS__,d=this.__IMAGE_CTX__;c.width=c.height=32,d.drawImage(g,0,18),d.font="bold 14px Arial",d.fillStyle="#39abed",d.strokeStyle="white",d.textAlign="center",d.textBaseline="middle",d.save(),d.lineWidth=2,d.shadowBlur=4,d.shadowColor="rgba(0,0,0,0.3)",d.shadowOffsetX=1,d.shadowOffsetY=2,d.strokeText(b,20,10),d.restore(),d.fillText(b,20,10);var e=c.toDataURL();return'url("'+e+'") 6 25, auto'},image2url:function(b){a._getHelperImageCanvas();var c=this.__IMAGE_CANVAS__,d=this.__IMAGE_CTX__;c.width=b.naturalWidth,c.height=b.naturalHeight,d.drawImage(b,0,0);var e=c.toDataURL();return c.width=c.height=0,e},canvas2image:function(b,c,d,e,f,g){a._getHelperImageCanvas();var h=b;"number"==typeof c?(this.__IMAGE_CANVAS__.width=e,this.__IMAGE_CANVAS__.height=f,this.__IMAGE_CTX__.drawImage(b,c,d,e,f,0,0,e,f),h=this.__IMAGE_CANVAS__):"function"==typeof c&&(g=c);var i=new Image;return"function"==typeof g&&(i.onload=function(){g()}),i.src=h.toDataURL(),i},image2scale:function(b,c,d){var e=a._getHelperImageCanvas(),f=this.__IMAGE_CTX__,g=b.width,h=b.height,i=Math.floor(g*c),j=Math.floor(h*c);e.width=i,e.height=j,f.drawImage(b,0,0,i,j);var k=new Image;return"function"==typeof d&&(k.onload=d),k.src=e.toDataURL(),k},genPoints:function(a){for(var b=[],c=0;a>c;c++)b.push({x:0,y:0});return b},_getEventPoint:function(a){var b=0,c=0;if("undefined"!=typeof a.pageX)b=a.pageX,c=a.pageY;else{if("undefined"==typeof a.clientX)throw"no x,y in event(_getEventPoint)";b=a.clientX,c=a.clientY}return{x:b,y:c}},getDomPosition:function(a){for(var b=0,c=0;null!=a;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return{left:b,top:c}},addEvent:function(b,c,d){"string"==typeof b&&(b=a(b)),window.addEventListener?b.addEventListener(c,d):b.attachEvent("on"+c,d)},delEvent:function(b,c,d){"string"==typeof b&&(b=a(b)),window.removeEventListener?b.removeEventListener(c,d):b.detachEvent("on"+c,d)},addGesture:function(b,c,d,e,f,g){"string"==typeof b&&(b=document.getElementById(b)),"function"!=typeof g&&(g=function(){});var h,i=!1,j=!1,k={scale:0,x:0,y:0},l=1,m=function(){d()},n=function(a,b,c){var d=0;return j||i||(h=a/k.scale,.97>h|h>1.03?i=!0:(Math.abs(b)>8||Math.abs(c)>8)&&(j=!0)),i?(h=a/k.scale,.88>h|h>1.12&&(e(a),d=1)):j&&(Math.abs(b)>10||Math.abs(c)>10)&&(f(b,c),d=2),d},o=function(b){i=!1,j=!1,k.x=0,k.y=0,a.stopEvent(b)},p={ie_timeout:null,ie_event:null},q=function(){p.ie_timeout=null,c(p.ie_event)};if(a.ie){var r=new MSGesture,s=[];r.target=b,a.addEvent(b,"MSGestureStart",function(b){l=b.scale,k.scale=b.scale,k.x=b.translationX,k.y=b.translationY,m(),a.stopEvent(b)}),a.addEvent(b,"MSGestureChange",function(b){k.x+=b.translationX,k.y+=b.translationY,l*=b.scale;var c=n(l,k.x,k.y);1===c?k.scale=l:2===c&&(k.x=0,k.y=0),a.stopEvent(b)}),a.addEvent(b,"MSGestureEnd",o),a.addEvent(b,a.touchEventType.start,function(a){var b=s.indexOf(a.pointerId);if(!(b>=0))if(0===s.length)s.push(a.pointerId),p.ie_event=a,p.ie_timeout=window.setTimeout(q,80);else if(1===s.length)for(null!==p.ie_timeout&&(window.clearTimeout(p.ie_timeout),p.ie_timeout=null),s.push(a.pointerId),b=0;b<s.length;b++)r.addPointer(s[b])}),a.addEvent(b,a.touchEventType.end,function(a){1===s.length&&(null!==p.ie_timeout&&(window.clearTimeout(p.ie_timeout),p.ie_timeout=null,c(p.ie_event)),g(a)),s.length=0})}else{var t=!1;a.addEvent(b,a.touchEventType.start,function(a){1===a.touches.length&&(t=!1,c(a))}),a.addEvent(b,"gesturestart",function(b){t=!0,k.scale=b.scale,k.x=b.pageX,k.y=b.pageY,m(),a.stopEvent(b)}),a.addEvent(b,"gesturechange",function(b){var c=n(b.scale,b.pageX-k.x,b.pageY-k.y);1===c?k.scale=b.scale:2===c&&(k.x=b.pageX,k.y=b.pageY),a.stopEvent(b)}),a.addEvent(b,"gestureend",o),a.addEvent(b,a.touchEventType.end,function(a){t===!1&&g(a)})}},addMouseEvent:function(b,c,d){var e={};if(a.touchable&&["mousedown","mousemove","mouseup"].indexOf(c)>=0){var f="mousedown"===c?a.touchEventType.start:"mousemove"===c?a.touchEventType.move:a.touchEventType.end,g=function(a){a.touches&&a.touches.length>1||a.changedTouches&&a.changedTouches.length>1||d.apply(this,arguments)};a.addEvent(b,f,g),e[f]=g}else a.addEvent(b,c,d),e[c]=d;return e},delMouseEvent:function(b,c){for(var d in c)a.delEvent(b,d,c[d])},createDelegate:function(a,b){return function(){b.apply(a,arguments)}},stopEvent:function(a){null!=a&&(a.preventDefault?a.preventDefault():a.returnValue=!1,a.stopPropagation?a.stopPropagation():a.cancelBubble=!0,a.preventManipulation&&a.preventManipulation())},addWheelEvent:function(b,c){"string"==typeof b&&(b=a(b)),window.addEventListener?a.firefox?b.addEventListener("DOMMouseScroll",c):b.addEventListener("mousewheel",c):b.attachEvent("onmousewheel",c)},inherit:function(a,b){if("undefined"==typeof a||"undefined"==typeof b)throw console.trace(),"inherit error!";for(var c in b.prototype){var d=a.prototype[c];"undefined"==typeof d&&(a.prototype[c]=b.prototype[c])}if(a.__base_objects__=new Array,a.__base_objects__.push(b),"undefined"!=typeof b.__base_objects__)for(var e=0;e<b.__base_objects__.length;e++)a.__base_objects__.push(b.__base_objects__[e]);a.prototype.base=function(b){var c=null,d=void 0;return"undefined"==typeof this.__inherit_base_deep__?this.__inherit_base_deep__=0:this.__inherit_base_deep__++,c=a.__base_objects__[this.__inherit_base_deep__],d="undefined"==typeof b||null==b?c.call(this):b instanceof Array==1?c.apply(this,b):c.apply(this,[].slice.call(arguments)),this.__inherit_base_deep__--,d},a.prototype.callBase=function(b,c){var d=null,e=void 0;"undefined"==typeof this.__inherit_deep__?this.__inherit_deep__=0:this.__inherit_deep__++,d=a.__base_objects__[this.__inherit_deep__];var f=d.prototype[b];if("function"!=typeof f)throw"There is no method:"+b+" in baseClass";return e="undefined"==typeof c||null===c?f.call(this):c instanceof Array==1?f.apply(this,c):f.apply(this,[].slice.call(arguments,1)),this.__inherit_deep__--,e}},__FONT_INFO_TABLE__:{},getFontInfo:function(a){var b=this.__FONT_INFO_TABLE__[a];return null==b&&(b=this.__FONT_INFO_TABLE__[a]=this._calcFontInfo(a)),b},_calcFontInfo:function(a){var b=document.createElement("div"),c=document.createElement("span"),d=document.createElement("span");b.style.margin="0px",b.style.padding="0px",b.style.position="relative",b.style.left="0px",b.style.top="0px",b.style.overflow="hidden",b.style.whiteSpace="nowrap",b.style.visibility="hidden",c.style.font=a,c.style.margin="0px",c.style.padding="0px",c.style.verticalAlign="baseline",c.style.whiteSpace="nowrap",d.style.font=a.replace(/\d+px/,"0px"),d.style.margin="0px",d.style.padding="0px",d.style.verticalAlign="baseline",c.style.whiteSpace="nowrap";var e="@白羊座小葛 04-02.I Love Diigo.南京大学";c.innerHTML=e,d.innerHTML=e,b.appendChild(d),b.appendChild(c),document.body.appendChild(b);var f=b.offsetHeight,g=c.offsetHeight+c.offsetTop-d.offsetTop;return document.body.removeChild(b),{height:f,baseline:d.offsetTop,baseline_offset:g}},getMiddlePoint:function(a,b){return{x:(a.x+b.x)/2,y:(a.y+b.y)/2}},drawBesier:function(b,c){var d=c.length;if(0!==d&&1!==d){b.beginPath();var e=null,f=c[0];b.moveTo(f.x,f.y);for(var g=0;d-1>g;g++)e=a.getMiddlePoint(c[g],c[g+1]),b.quadraticCurveTo(f.x,f.y,e.x,e.y),f=c[g+1];e=c[d-1],b.quadraticCurveTo(f.x,f.y,e.x,e.y),b.stroke(),b.closePath()}},drawLine:function(a,b,c,d,e){a.beginPath(),a.moveTo(b,c),a.lineTo(d,e),a.stroke(),a.closePath()},drawLine_w:function(b,c,d,e,f){a.drawLine(b,c,d,c+e,d+f)},drawEllipse:function(a,b,c,d,e,f){a.beginPath(),a.ellipse(b,c,d,e,0,0,2*Math.PI,0),a.closePath(),null!==f&&(a.fillStyle=f,a.fill()),a.stroke()},calcArrow:function(b,c,d,e,f){function g(a,b,c,d,e){var f=[0,0],g=a*Math.cos(c)-b*Math.sin(c),h=a*Math.sin(c)+b*Math.cos(c);if(d){var i=Math.sqrt(g*g+h*h);g=g/i*e,h=h/i*e,f[0]=g,f[1]=h}return f}var h=a.getPTPRange_xy(b,c,d,e),i=f,j=.42*i,k=Math.atan(j/i),l=Math.sqrt(j*j+i*i),m=g(d-b,e-c,k,!0,l),n=g(d-b,e-c,-k,!0,l),o=Math.floor(d-m[0]),p=Math.floor(e-m[1]),q=Math.floor(d-n[0]),r=Math.floor(e-n[1]),s=i/h,t=Math.floor(d-(d-b)*s);return y5=Math.floor(e-(e-c)*s),{ax:o,ay:p,bx:q,by:r,cx:t,cy:y5,dx:d,dy:e}},drawArrow:function(b,c,d,e,f){var g=a.calcArrow(c,d,e,f);a.drawLine(b,e,f,g.ax,g.ay),a.drawLine(b,e,f,g.bx,g.by)},clearContext:function(a){a.clearRect(a.canvas.width,a.canvas.height)},copyArray:function(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);return b},setArray:function(a,b){for(var c=0;c<a.length;c++)a[c]=b[c]},copyPoints:function(a){var b=[];if(0===a.length)return b;for(var c="undefined"!=typeof a[0].p,d=0;d<a.length;d++){var e={x:a[d].x,y:a[d].y};c&&(e.p=a[d].p),b.push(e)}return b},setPoints:function(a,b){if(0!==a.length&&a.length===b.length)for(var c=0;c<a.length;c++)a[c].x=b[c].x,a[c].y=b[c].y},getPTPRange:function(a,b){return Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2))},getPTPRange_xy:function(a,b,c,d){return Math.sqrt(Math.pow(a-c,2)+Math.pow(b-d,2))},color2int:function(a){return a[0]<<16|a[1]<<8|a[2]},int2color:function(a){var b=(16711680&a).toString(16),c=(65280&a).toString(16),d=(255&a).toString(16),e="#"+(1===b.length?"0":"")+b+(1===c.length?"0":"")+c+(1===d.length?"0":"")+d;return e},rgba2str:function(a,b,c,d){return"undefined"!=typeof d?"rgba("+a+","+b+","+c+","+d+")":"#"+(10>a?"0":"")+a.toString(16).toUpperCase()+(10>b?"0":"")+b.toString(16).toUpperCase()+(10>c?"0":"")+c.toString(16).toUpperCase()},str2rgba:function(a){var b,c=0,d=0,e=0,f=1;return/^#[0-9a-f]{3}$/i.test(a)?(c=parseInt(a.substr(1,1)+a.substr(1,1),16),d=parseInt(a.substr(2,1)+a.substr(2,1),16),e=parseInt(a.substr(3,1)+a.substr(3,1),16),f=1):/^#[0-9a-f]{6}$/i.test(a)?(c=parseInt(a.substr(1,2),16),d=parseInt(a.substr(3,2),16),e=parseInt(a.substr(5,2),16),f=1):null!=(b=a.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i))&&(c=parseInt(b[1]),d=parseInt(b[2]),e=parseInt(b[3]),f=1),null!=(b=a.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d(\.\d+)?)\s*\)$/i))&&(c=parseInt(b[1]),d=parseInt(b[2]),e=parseInt(b[3]),f=parseFloat(b[4])),{r:c,g:d,b:e,a:f}},is_color_blank:function(a){return"#000000"===a||"#000"===a||"blank"===a||/^rgba\(\s*0\s*,\s*0\s*,\s*0\s*,\s*0\s*\)$/i.test(a)||/^rgb\(\s*0\s*,\s*0\s*,\s*0\s*\)$/i.test(a)},setLineDash:function(a,b){"undefined"!=typeof a.setLineDash?a.setLineDash(b):"undefined"!=typeof a.mozDash&&(a.mozDash=b)},getCanvasBlob:function(a){if(a.toBlob)return a.toBlob();for(var b=a.toDataURL("image/png"),c=atob(b.substring("data:image/png;base64,".length)),d=new Uint8Array(c.length),e=0,f=c.length;f>e;++e)d[e]=c.charCodeAt(e);return new Blob([d.buffer],{type:"image/png"})},dataUrl2Blob:function(a){for(var b=atob(a.substring("data:image/png;base64,".length)),c=new Uint8Array(b.length),d=0,e=b.length;e>d;++d)c[d]=b.charCodeAt(d);return new Blob([c.buffer],{type:"image/png"})}})}(Diigo.$),function(a){a.fn.extend({addMouseEvent:function(a,b,c){var d="function"==typeof b?b:"function"==typeof c?c:function(){},f=0,g=function(a){e=a.originalEvent,e.touches&&e.touches.length>1||e.changedTouches&&e.changedTouches.length>1||d.apply(this,arguments)},h=function(a){f>0&&a.timeStamp-f>800||d.apply(this,arguments)},i="mousedown"===a?Diigo.$.touchEventType.start:"mousemove"===a?Diigo.$.touchEventType.move:Diigo.$.touchEventType.end;return Diigo.$.touchable&&["mousedown","mousemove","mouseup"].indexOf(a)>=0?"function"==typeof b?this.on(i,g):(this.on(i,b,g),this.on(a,b,h)):"function"==typeof b?this.on(a,b):this.on(a,b,c),this},addMouseDownEvent:function(a,b){return this.addMouseEvent("mousedown",a,b)},addMouseMoveEvent:function(a,b){return this.addMouseEvent("mousemove",a,b)},addMouseUpEvent:function(a,b){return this.addMouseEvent("mouseup",a,b)},addMouseTagEvent:function(a,b){var c=!0,d=Diigo.$.touchEventType.start,e=Diigo.$.touchEventType.end;"function"==typeof a&&(b=a,c=!1);var f={x:0,y:0},g=function(a){a=a.originalEvent||a,a.touches&&a.touches.length>0?(f.x=a.touches[0].pageX,f.y=a.touches[0].pageY):(f.x=a.pageX,f.y=a.pageY)},h=function(a){a=a.originalEvent||a;var c,d;a.changedTouches&&a.changedTouches.length>0?(c=a.changedTouches[0].pageX,d=a.changedTouches[0].pageY):(c=a.pageX,d=a.pageY),Math.sqrt(Math.pow(f.x-c,2)+Math.pow(f.y-d,2)<20)&&b.apply(this,arguments)};return Diigo.$.touchable?c?(this.on(d,a,g),this.on(e,a,h)):(this.on(d,g),this.on(e,h)):c?this.on("mousedown",a,b):this.on("mousedown",b),this}}),a.stopEvent=function(a){"undefined"!=typeof a&&(a.preventDefault(),a.stopPropagation())}}(jQuery),function(a,b,c,d){b._Drawer=function(a,d){this.parent=a,this.container=a.container,this.out_container=a.out_container,this.edit_canvas=a.layer_canvas,this.doodle_canvas=a.doodle_canvas,this.textarea=a.textarea,this.textarea_out=a.textarea_out,this.$list_dialog=a.$list_dialog,this.$list_input=this.$list_dialog.find("input"),this.choose_canvas=document.createElement("canvas"),this.temp_canvas=document.createElement("canvas"),this.image_canvas=document.createElement("canvas"),this.blur_canvas=document.createElement("canvas"),this.i_ctx=this.image_canvas.getContext("2d"),this.d_ctx=this.doodle_canvas.getContext("2d"),this.e_ctx=this.edit_canvas.getContext("2d"),this.c_ctx=this.choose_canvas.getContext("2d"),this.t_ctx=this.temp_canvas.getContext("2d"),this.b_ctx=this.blur_canvas.getContext("2d"),this.out_pos=null,this.style={brush_type:b.Type.CURVE,pen_width:4,pen_opacity:1,pen_color:"#000",dot_type:b.LineType.NORMAL,arrow_type:b.LineType.NORMAL,color:"rgba(0,0,0,1.0)",text_color:"#000000",font_size:20,font_name:"Times New Roman",svg_image:new Image},this.cur_textbox=null,this.history=new c._UndoRedoManager(this),this.zoom_scale=1,this.page={doodle_array:[]},this.edit_doodle=new b._EditDoodle(this),this.temp_doodle=null,this.has_selected_doodle=!1,this.default_cursor="url(images/pencil.png),auto",this.image_canvas.width=a.image.naturalWidth,this.image_canvas.height=a.image.naturalHeight,this.i_ctx.drawImage(a.image,0,0),this.bg_info={saved_origin:null,origin_image:null,image:this.image_canvas,x:0,y:0,width:a.image.naturalWidth,height:a.image.naturalHeight},this.__pre_mouse_enter_region__=null,this.__region_visible__=!0,this.cut_mode=!1,this.cut_doodle=null,this.__cut_undo_command__=null,this.__tmp_undo_command__=null,this.style_callback=d,this.initEvent(),this.textbox_editor=new Diigo.Text._Editor(this),this.pre_cursor_name="",this.cursor_type=1,this.d_changed=!1},b._Drawer.prototype={onChange:function(){},setCursor:function(a){jQuery(this.edit_canvas).removeClass(this.pre_cursor_name),this.edit_canvas.style.cursor=a,this.pre_cursor_name=""},setCursor_name:function(a){this.edit_canvas.style.cursor="",jQuery(this.edit_canvas).removeClass(this.pre_cursor_name).addClass(a),this.pre_cursor_name=a},blur:function(){this.focused&&(d.log("d blur"),this.focused=!1)},focus:function(){this.focused||(d.log("d focus"),d.touchable||this.caret.focus(),this.focused=!0),null!==this.cur_textbox&&this.cur_textbox.actived&&this.cur_textbox.editor.focus()},isEdited:function(){var a=this.bg_info,b=this.page.doodle_array.length;return b>0||a.width!==a.origin_image.naturalWidth||a.height!==a.origin_image.naturalHeight||0!==a.x||0!==a.y||a.width!==a.image.width||a.height!==a.image.height},isChanged:function(){return this.isEdited()||this.d_changed},setBgImage:function(a,b){this.bg_info.origin_image=a,this.bg_info.saved_origin=null,this.image_canvas.width=a.naturalWidth,this.image_canvas.height=a.naturalHeight,this.i_ctx.drawImage(a,0,0),this.bg_info.iamge=this.image_canvas,this.bg_info.width=a.naturalWidth,this.bg_info.height=a.naturalHeight,this.bg_info.x=0,this.bg_info.y=0,this.zoom_scale=1,this._clear(),this._do_resize(),this.d_changed=!1;var c=this;this.out_container.style.visibility="hidden",b?window.setTimeout(function(){c._on_resize(),c.setFitScale(),c.out_container.style.visibility="visible",c.paint()},0):window.setTimeout(function(){c._on_resize(),c.out_container.style.visibility="visible",c.paint()},0)},resize:function(){this.zoom_scale=1,this._resize(),this.paint()},_do_resize:function(){var a=Math.floor(this.bg_info.width*this.zoom_scale),b=Math.floor(this.bg_info.height*this.zoom_scale);this.edit_canvas.width=a,this.edit_canvas.height=b,this.doodle_canvas.width=a,this.doodle_canvas.height=b,this.choose_canvas.height=b,this.choose_canvas.width=a,this.temp_canvas.width=a,this.temp_canvas.height=b,this.blur_canvas.width=a,this.blur_canvas.height=b,this.container.style.width=a+"px",this.container.style.height=b+"px",this.out_container.scrollLeft=0,this.out_container.scrollTop=0},_resize:function(){this._do_resize(),this._on_resize()},_resetDoodleScale:function(){for(var a=this.page.doodle_array,b=0;b<a.length;b++)a[b].resetScale()},setScale:function(a){this.zoom_scale=a,this._resetDoodleScale(),this._resize(),this.paint()},setFitScale:function(){var a=this.out_container,b=a.offsetWidth,c=a.offsetHeight,d=this.bg_info,e=b/d.width,f=c/d.height;this.setScale(1>e||1>f?Math.min(e,f):1)},setImageSize:function(a,b){null!==this.cur_textbox&&this.unactiveTextbox(),this.hideListDialog(),this.__tmp_undo_command__=new c._SizeCommand(this),this._set_image_size_redo(a,b),this.__tmp_undo_command__.finish(),this.history.add(this.__tmp_undo_command__),this.__tmp_undo_command__=null},_set_image_size_undo:function(a,b,c){var d=this.bg_info;this.zoom_scale=1,this.image_canvas.width=a.width,this.image_canvas.height=a.height,this.i_ctx.drawImage(a,0,0),d.x=b.x,d.y=b.y,d.width=b.width,d.height=b.height,this._resize(),[].push.apply(this.page.doodle_array,c),this.paint(),this._clear_back()},_set_image_size_redo:function(a,b){this._select_nothing();var c=this.d_ctx,d=this.zoom_scale,e=this.bg_info;this.zoom_scale=1,this.d_ctx=this.b_ctx,this.blur_canvas.width=e.width,this.blur_canvas.height=e.height,this._paintDoodleLayer(),this.d_ctx=c,this.image_canvas.width=a,this.image_canvas.height=b,this.i_ctx.drawImage(this.blur_canvas,0,0,e.width,e.height,0,0,a,b),e.width=a,e.height=b,e.x=0,e.y=0,this.zoom_scale=d,this._resize(),this.page.doodle_array.length=0,this._clear_back(),this.paint()},_get_image:function(a,b){null!==this.cur_textbox&&this.unactiveTextbox(),this._select_nothing();var c,e=this.bg_info,f=this.d_ctx,g=this.zoom_scale,h=this.blur_canvas.width,i=this.blur_canvas.height;return this.zoom_scale=1,this._resetDoodleScale(),this.d_ctx=this.b_ctx,this.blur_canvas.width=e.width,this.blur_canvas.height=e.height,this._paintDoodleLayer(),c="url"===a?this.blur_canvas.toDataURL(b):d.getCanvasBlob(this.blur_canvas),this.d_ctx=f,this.zoom_scale=g,this._resetDoodleScale(),this.blur_canvas.width=h,this.blur_canvas.height=i,c},getImageDataURL:function(a){return this._get_image("url",a)},getImageDataBlob:function(){return this._get_image("blob")},_removeDoodle:function(a){null!==this.cur_textbox&&(this.unactiveTextbox(),this.textbox_editor.hide());var b=this.page.doodle_array,c=b.indexOf(a);b.splice(c,1),this._select_nothing(),this._clear_back()},_insertDoodle:function(a){this.page.doodle_array.unshift(a),this._clear_back()},_ur_insert:function(a){this.page.doodle_array.unshift(a),this._select_doodle(a),this._clear_back()},insertDoodle:function(a){var b=new c._DoodleNewCommand(a);this._insertDoodle(a),this.history.add(b)},unactiveTextbox:function(){null!==this.cur_textbox&&this.cur_textbox.actived&&(this.cur_textbox.unactive(),this.cur_textbox=null,this._select_nothing())},activeTextbox:function(){this._select_nothing(),this.cur_textbox.selected=!0,this.has_selected_doodle=!0,this.attachCurTextbox(),this.cur_textbox.active(),this.style_callback("btn","text")},attachCurTextbox:function(){this.edit_doodle.attachDoodle(this.cur_textbox),this._paintEditLayer()},activeInnerTextbox:function(){this.cur_textbox.active(),this.style_callback("btn","text")},delTextbox:function(a){var b=this.page.doodle_array.indexOf(a);b>=0&&this.page.doodle_array.splice(b,1),this.cur_textbox=null},paint:function(){this._paintDoodleLayer(),this._paintEditLayer(),this._paintChooseLayer()},_prepare_for_blur:function(){},_finish_for_blur:function(){},_paintDoodleLayer:function(){var a=this.bg_info,b=this.d_ctx,c=this.t_ctx,d=this.zoom_scale;b.save(),c.save(),b.lineCap="round",b.lineJoin="round",c.lineCap="round",c.lineJoin="round",b.scale(d,d),b.translate(-a.x,-a.y),c.scale(d,d),c.translate(-a.x,-a.y),b.clearRect(a.x,a.y,a.width,a.height),b.drawImage(a.image,a.x,a.y,a.width,a.height,a.x,a.y,a.width,a.height);for(var e=this.page.doodle_array,f=e.length-1;f>=0;f--)e[f].selected||e[f].draw(b);b.restore(),c.restore()},_clear_ctx:function(a){var b=this.bg_info;a.clearRect(b.x,b.y,b.width,b.height)},_select_nothing:function(){var a=this.page.doodle_array;this.has_selected_doodle=!1;for(var b=0;b<a.length;b++)a[b].selected=!1;this.edit_doodle.attachNothing(),this._select_back()},_select_doodle:function(a){for(var b=this.page.doodle_array,c=0;c<b.length;c++)b[c].selected=!1;this.has_selected_doodle=!0,a.selected=!0,this.edit_doodle.attachDoodle(a),this._select_back()},_paintEditLayer:function(){function a(a,b,c){for(var d=b.edit_regions,e=0;e<d.length;e++)d[e].draw(a,c)}var c=this.page.doodle_array,d=this.e_ctx,e=this.bg_info,f=this.t_ctx,g=this.zoom_scale,h=e.width,i=e.height;d.save(),f.save(),d.lineCap="round",d.lineJoin="round",f.lineCap="round",f.lineJoin="round",d.scale(g,g),d.translate(-e.x,-e.y),f.scale(g,g),f.translate(-e.x,-e.y),d.clearRect(e.x,e.y,h,i),this.cut_mode&&(d.fillStyle="rgba(0, 0, 0, 0.3)",d.fillRect(e.x,e.y,h,i));for(var j=c.length-1;j>=0;j--)c[j].selected&&c[j].draw_select(d);var k=this.temp_doodle;if(null!==k&&(k.type===b.Type.RECT_BLUR?k.draw_blur(d,this.blur_canvas):k.draw(d)),null!==this.cut_doodle)this.cut_doodle.draw(d),a(d,this.cut_doodle,this.zoom_scale);else if(this.__region_visible__){for(j=c.length-1;j>=0;j--)if(c[j].selected){a(d,c[j],this.zoom_scale);break}a(d,this.edit_doodle,this.zoom_scale)}d.restore(),f.restore()},_paintChooseLayer:function(){var a,b=this.page.doodle_array,c=this.c_ctx,d=this.bg_info,e=this.t_ctx,f=this.zoom_scale;if(c.save(),e.save(),c.lineCap="round",c.lineJoin="round",e.lineCap="round",e.lineJoin="round",c.scale(f,f),c.translate(-d.x,-d.y),e.scale(f,f),e.translate(-d.x,-d.y),c.clearRect(d.x,d.y,d.width,d.height),!this.cut_mode)for(a=b.length-1;a>=0;a--)b[a].draw_choose(c,a);null!==this.cut_doodle&&this.cut_doodle.draw_choose(c,b.length),c.restore(),e.restore()},cutImage:function(){null!==this.cur_textbox&&this.unactiveTextbox(),this.cut_saved={brush:this.style.brush_type,cursor:this.default_cursor,cursor_type:this.cursor_type},this.hideListDialog(),this.cursor_type=1,this.style.brush_type=b.Type.CUT,this.default_cursor="cursor_crosshair",this.setCursor_name(this.default_cursor),this.cut_mode=!0,this._select_nothing(),this.edit_doodle.attachNothing(),this.paint(),this.__cut_undo_command__=new c._CropCommand(this)},setCropSize:function(a,b){this.cut_mode&&(this.cut_doodle.setSize(a,b),this._paintEditLayer(),this._paintChooseLayer())},set_bg_info:function(a){var b=this.bg_info;b.x=a.x,b.y=a.y,b.width=a.w,b.height=a.h,this._resize(),this.paint()},finishCutImage:function(a){if(a&&null!==this.cut_doodle){var c=this.cut_doodle.points,d=Math.min(c[0].x,c[1].x),e=Math.min(c[0].y,c[1].y),f=Math.max(c[0].x,c[1].x),g=Math.max(c[0].y,c[1].y),h=this.bg_info;d=Math.max(d,h.x),e=Math.max(e,h.y),f=Math.min(f,h.x+h.width),g=Math.min(g,h.y+h.height),h.x=d,h.y=e,h.width=f-d,h.height=g-e,this._resize(),this._clear_back(),this.__cut_undo_command__.finish(),this.history.add(this.__cut_undo_command__),this.__cut_undo_command__=null;for(var i=this.page.doodle_array,j=b.Type,k=0;k<i.length;k++)i[k].type===j.TEXT?i[k]._calc():i[k].type===j.CALLOUT&&i[k].child_textbox._calc()}this.cursor_type=this.cut_saved.cursor_type,this.default_cursor=this.cut_saved.cursor,this.style.brush_type=this.cut_saved.brush,2===this.cursor_type?this.setCursor(this.default_cursor):this.setCursor_name(this.default_cursor),this.cut_mode=!1,this.cut_doodle=null,this.has_selected_doodle=!1,this.paint()},setPenWidth:function(a){this.style.pen_width=a;var b=this.page.doodle_array;if(this.has_selected_doodle){for(var d=0;d<b.length;d++)if(b[d].selected){var e=b[d].pen_width;b[d].setPenWidth(a),this.history.add(new c._DoodleWidthCommand(b[d],e,a));break}this.paint()}},setPenOpacity:function(a){this.style.pen_opacity=a,this._get_color()},setPenColor:function(a){this.style.pen_color=a,this._get_color()},setArrowType:function(a){this.style.arrow_type=a},setPenType:function(a){var c=b.Type[a.toUpperCase()];if(this.style.brush_type=c,c===b.Type.LIST){var d=b._ListDoodle.__LAST_INFO__;d.color=this.style.color,this.default_cursor=d.getCursor(),this.setCursor(this.default_cursor),this.cursor_type=2}else this.default_cursor="cursor_"+a,this.setCursor_name(this.default_cursor),this.cursor_type=1},setSvgImage:function(a){this.style.svg_image=a},insertSvgImage:function(a){this.style.svg_image=a;var c=this.zoom_scale,d=this.container,e=this.out_container,f=Math.min(e.offsetWidth,d.offsetWidth),g=Math.min(e.offsetHeight,d.offsetHeight),h=a.width,i=a.height,j=e.scrollTop,k=e.scrollLeft,l=this.bg_info,m=Math.floor(((f-h*c)/2+k)/c),n=Math.floor(((g-i*c)/2+j)/c),o=b.create(b.Type.IMAGE,{drawer:this,image:this.style.svg_image.image,width:h,height:i,choose_type:a.choose_type,points:[{x:m+l.x,y:n+l.y},{x:m+l.x+h,y:n+l.y+i}]});o.initialize(),this.insertDoodle(o),this._select_doodle(o),this.paint()},_get_color:function(){var a=d.str2rgba(this.style.pen_color);this.style.color=d.rgba2str(a.r,a.g,a.b,this.style.pen_opacity),b._ListDoodle.__LAST_INFO__.color=this.style.color;var e=this.page.doodle_array;if(this.has_selected_doodle){for(var f=0;f<e.length;f++)if(e[f].selected){var g=e[f].color;e[f].setColor(this.style.color),this.history.add(new c._DoodleColorCommand(e[f],g,this.style.color));break}this.paint()}},_get_selected_shape:function(){if(this.has_selected_doodle)for(var a=this.page.doodle_array,b=0;b<a.length;b++)if(a[b].selected)return a[b];return null},setFontName:function(a){this.style.font_name=a;var c=b.Type,d=this.cur_textbox||this._get_selected_shape();null===d||d.type!==c.TEXT&&d.type!==c.INNERTEXT&&d.type!==c.CALLOUT||d.setFontName(a)},setFontSize:function(a){this.style.font_size=a;var c=b.Type,d=this.cur_textbox||this._get_selected_shape();null===d||d.type!==c.TEXT&&d.type!==c.INNERTEXT&&d.type!==c.CALLOUT||d.setFontSize(a)},undo:function(){this.history.undo(),this._ur_back()},redo:function(){this.history.redo(),this._ur_back()},_clear:function(){this.page.doodle_array.length=0,this.history.clear(),this._select_nothing(),this._clear_back()},clear:function(){this._clear(),this.d_changed=!0;var a=this.bg_info;a.x=0,a.y=0,a.width=a.origin_image.naturalWidth,a.height=a.origin_image.naturalHeight,a.image.width=a.width,a.image.height=a.height,this.i_ctx.drawImage(a.origin_image,0,0),this.reset_list(),this._resize(),this.paint(),this._clear_back()},saveOrigin:function(a){if(null!==this.bg_info.saved_origin)a();else{var b=new Image;b.src=d.image2url(this.bg_info.origin_image),b.onload=a,this.bg_info.saved_origin=b}},restoreOrigin:function(){this.bg_info.origin_image=this.bg_info.saved_origin},_ur_back:function(){this.style_callback("undo",this.history.canUndo()),this.style_callback("redo",this.history.canRedo())},_select_back:function(){this.style_callback("del",this.has_selected_doodle);
var a=this.edit_doodle.selected_doodle,c=b.Type,d=null!==a?a.type:this.style.brush_type;d===c.LIST&&this.style.brush_type!==c.LIST&&(d=this.style.brush_type);var e=d===c.CALLOUT||d===c.TEXT?"text":d===c.LIST?"list":"other";this.style_callback("btn",e)},_clear_back:function(){this.style_callback("clear",this.isEdited()===!1)},deleteSelected:function(){var a=null,b=this.page.doodle_array;if(this.has_selected_doodle)for(var d=0;d<b.length;d++)if(b[d].selected){a=b[d];break}null!==a&&(this._removeDoodle(a),this.history.add(new c._DoodleDelCommand(a)),this.paint())},reset_list:function(){var a=b._ListDoodle.__LAST_INFO__;a.reset()},resetList:function(){var a=b._ListDoodle.__LAST_INFO__;this.reset_list(),this.default_cursor=a.getCursor(),this.setCursor(this.default_cursor),this.hideListDialog()}}}(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b){a._Doodle=function(a,b){this.type=a,this.drawer=b.drawer,this.points=b.points,this.color="undefined"==typeof b.color?"rgba(0,0,0,1.0)":b.color,this.highlight_color=this._calc_highlight_color(this.color),this.pen_width="undefined"==typeof b.pen_width?3:b.pen_width,this.line_type="undefined"==typeof b.line_type?0:b.line_type,this.fill_color="undefined"==typeof b.fill_color?null:b.fill_color,this.child_textbox=null,this.selected=!1,this.is_eraser=b.is_eraser?!0:!1,this.has_shadow=!1,this.region_points=b.region_points?b.region_points:this.points,this.initialized=!1,this.edit_regions=[],this.boundary={left:0,top:0,height:0,width:0}},a.Type={CURVE:1,LINE:2,RECT:3,ELLIPSE:4,HIGHLIGHT:1,RECT_BLUR:5,CURVE_BLUR:6,CALLOUT:7,LIST:8,LINE_ARROW:20,CURVE_ARROW:21,BEZIER_ARROW:22,IMAGE:30,ERASER:60,TEXT:80,INNERTEXT:81,CUT:8888,EDITHELPER:999},a.LineType={NORMAL:0,DASH_ONE:1,DASH_TWO:2,DASH_THREE:4,LEFT_ARROW:8,RIGHT_ARROW:16,DOUBLE_ARROW:32,SEED:128,FILL:256,MATRIX:512},a.create=function(c,d){var e=a.Type;switch(c){case e.ERASER:return new a._SimpleEraserDoodle(d);case e.LINE:return new a._LineDoodle(d);case e.RECT:return new a._RectDoodle(d);case e.ELLIPSE:return new a._EllipseDoodle(d);case e.CURVE:return new a._CurveDoodle(d);case e.RECT_BLUR:return new a._RectBlurDoodle(d);case e.CURVE_BLUR:return new a._CurveBlurDoodle(d);case e.TEXT:return new a._TextboxDoodle(d);case e.INNERTEXT:return new a._InnerTextboxDoodle(d);case e.CUT:return new a._CutDoodle(d);case e.CALLOUT:return new a._CalloutDoodle(d);case e.LIST:return new a._ListDoodle(d);case e.IMAGE:return new a._ImageDoodle(d);case e.LINE_ARROW:return new a._LineArrowDoodle(d);case e.CURVE_ARROW:return new a._CurveArrowDoodle(d);case e.BEZIER_ARROW:return new a._BezierArrowDoodle(d);default:return b.log("unkown type of doodle: "+c),new a._CurveDoodle(d)}},a._Doodle.prototype={setRegionDisabled:function(a){for(var b=0;b<this.edit_regions.length;b++)this.edit_regions[b].disabled=a},initialize:function(){this.initialized=!0},onRegionEdit:function(){},onRegionEditStart:function(){},onRegionEditFinish:function(){},getRotateUndoCommand:function(){return null},getMoveUndoCommand:function(){return null},getRegionUndoCommand:function(){return null},afterUndoRedo:function(){this._calc(),this.drawer._select_doodle(this)},_create_edit_region:function(){for(var b=0;b<this.region_points.length;b++)this.edit_regions.push(new a.CircleRegion(this,b,this.region_points[b],Math.round((Math.max(this.pen_width,8)+6)/2),"pointer"))},setPenWidth:function(a){this.pen_width=a;for(var b=0;b<this.edit_regions.length;b++)this.edit_regions[b].radius=Math.round((Math.max(this.pen_width,8)+6)/2)},setColor:function(a){this.color=a,this.highlight_color=this._calc_highlight_color(a)},_calc_highlight_color:function(){var a=b.str2rgba(this.color);return a.r>=200&&a.b>=200&&a.g>=200?"rgba(0,0,0,0.3)":"rgba(255, 255, 255, "+a.a+")"},getSelectedColor:function(){},getRotatePoint:function(){return null},_calc_1:function(a){for(var b=a[0],c=b.x,d=b.y,e=b.x,f=b.y,g=this.boundary,h=0;h<a.length;h++)b=a[h],b.x<c&&(c=b.x),b.x>e&&(e=b.x),b.y<d&&(d=b.y),b.y>f&&(f=b.y);g.width=e-c,g.height=f-d,g.left=c,g.top=d,g.right=e,g.bottom=f},_calc_2:function(a,b,c,d){var e=this.boundary;e.width=Math.abs(a-c),e.height=Math.abs(b-d),e.left=Math.min(a,c),e.top=Math.min(b,d),e.right=e.left+e.width,e.bottom=e.top+e.height},set_child_textbox:function(){},_doDraw:function(){throw"abstract method _doDraw"},draw_choose:function(a,c){var d=b.int2color(c);a.strokeStyle=d,a.fillStyle=d,a.lineWidth=Math.round(1.5*this.pen_width),this._doChooseDraw(a,d)},draw_select:function(a){a.save(),a.strokeStyle=this.highlight_color,a.shadowColor="rgba(0, 0, 0, 0.4)",a.shadowOffsetX=0,a.shadowOffsetY=2,a.shadowBlur=4,a.lineWidth=Math.floor(this.pen_width+6),this._doSelectDraw(a),a.restore(),this.draw(a)},draw_region:function(a,b,c){this.draw_select(a,c);for(var d=0;d<this.edit_regions.length;d++)this.edit_regions[d].draw(a,b)},_doChooseDraw:function(a,b){this._doDraw(a,b)},_doSelectDraw:function(a){this._doDraw(a)},draw:function(){throw"abstruct methon draw"},drawFPT:function(a,b,c,d){this.draw(a,b,c,d)},_typed_draw:function(c){c.save(),c.strokeStyle=this.color,c.lineWidth=this.pen_width;var d=a.LineType,e=null,f=this.line_type;(f&d.DASH_ONE)>0?b.setLineDash(c,[1,5]):(f&d.DASH_TWO)>0?b.setLineDash(c,[6,5]):(f&d.DASH_THREE)>0&&b.setLineDash(c,[6,5,1,5]),(f&d.LEFT_ARROW)>0?e=this._drawLeftArrow:(f&d.RIGHT_ARROW)>0?e=this._drawRightArrow:(f&d.DOUBLE_ARROW)>0&&(e=this._drawDoubleArrow),this._doDraw(c,this.fill_color,this.has_shadow),null!==e&&e.call(this,c),c.restore(),null!==this.child_textbox&&this.child_textbox.draw(c)},_normal_draw:function(a,b,c,d){a.strokeStyle=this.color,a.lineWidth=this.pen_width,this._doDraw(a,this.fill_color,b,c,d)},editMove:function(){throw"absolute method editMove"},editRotateScale:function(){throw"absolute method editRotateScale"},rotateScale:function(){throw"absolute method rotateScale"},move:function(){throw"absolute method move"},editStart:function(){throw"absolute methon editStart"},editFinish:function(){this._calc()},editPushPoint:function(){throw"absolute method editPushPoint"},_drawLeftArrow:function(){},_drawRightArrow:function(){},_drawDoubleArrow:function(a){this._drawLeftArrow(a),this._drawRightArrow(a)},setFillColor:function(){return!1},resetScale:function(){}}}(Diigo.Doodle,Diigo.$),function(a,b,c){a._CommonDoodle=function(a,b){this.base(a,b),this.pre_points=c.copyPoints(this.points),this.rotate_point={x:0,y:0},this._calc()},a._CommonDoodle.prototype={getRotatePoint:function(){return null},getMoveUndoCommand:function(){return new b._DoodlePointsCommand(this)},_calc:function(){this._calc_1(this.points);var a=this.boundary;this.rotate_point.x=Math.floor(a.left+a.width/2),this.rotate_point.y=a.top-20},draw:function(a,b,c,d){this._typed_draw(a,b,c,d)},editMove:function(a,b){for(var c=0;c<this.points.length;c++)this.points[c].x=this.pre_points[c].x+a,this.points[c].y=this.pre_points[c].y+b;this._calc()},move:function(a,b){for(var c=0;c<this.points.length;c++)this.points[c].x+=a,this.points[c].y+=b;this._calc()},editStart:function(){c.setPoints(this.pre_points,this.points)},editPushPoint:function(a){this.points.push(a),this.pre_points.push({x:0,y:0}),this._calc()}},c.inherit(a._CommonDoodle,a._Doodle),a._CurveDoodle=function(b){if(1===b.points.length){var c=b.points[0],d=b.pen_width,e={x:c.x+d/4,y:c.y};b.points.push(e)}this.base(a.Type.CURVE,b)},a._CurveDoodle.prototype={_doDraw:function(a){c.drawBesier(a,this.points)},_drawLeftArrow:function(a){var b=this.points,d=b[0],e=b.length>1?b[1]:d;c.drawArrow(a,e.x,e.y,d.x,d.y)},_drawRightArrow:function(a){var b=this.points,d=b[b.length-1],e=b.length>1?b[b.length-2]:d;c.drawArrow(a,e.x,e.y,d.x,d.y)}},c.inherit(a._CurveDoodle,a._CommonDoodle),a._LineDoodle=function(b){1===b.points.length&&b.points.push({x:b.points[0].x,y:b.points[0].y}),this.base(a.Type.LINE,b),this.region_points=this.points,this._create_edit_region()},a._LineDoodle.prototype={_calc:function(){var a=this.points;this._calc_2(a[0].x,a[0].y,a[1].x,a[1].y)},_doDraw:function(a){var b=this.points;c.drawLine(a,b[0].x,b[0].y,b[1].x,b[1].y)},_drawLeftArrow:function(a){var b=this.points,d=b[0],e=b[1];c.drawArrow(a,e.x,e.y,d.x,d.y)},_drawRightArrow:function(a){var b=this.points,d=b[1],e=b[0];c.drawArrow(a,e.x,e.y,d.x,d.y)},editPushPoint:function(a){this.points[1].x=a.x,this.points[1].y=a.y,this._calc()},getRegionUndoCommand:function(){return new b._DoodlePointsCommand(this)},onRegionEdit:function(a,b){this.points[a].x=b.x,this.points[a].y=b.y,this._calc(),this.drawer.edit_doodle.attachDoodle(this)},onRegionEditFinish:function(){this.drawer.edit_doodle.attachDoodle(this)}},c.inherit(a._LineDoodle,a._CommonDoodle),a._LineArrowDoodle=function(a){this.arrow_info={idx:0,pos:{}},this.base(a)},a._LineArrowDoodle.prototype={setPenWidth:function(a){this.callBase("setPenWidth",a),this._calc_arrow()},draw:function(a){var b=this.drawer.t_ctx,c=this.drawer.bg_info;b.save(),b.fillStyle=this.color,b.strokeStyle=this.color,b.lineWidth=this.pen_width,b.clearRect(c.x,c.y,c.width,c.height),this._doDraw(b),b.restore(),a.save(),a.setTransform(1,0,0,1,0,0),a.drawImage(b.canvas,0,0),a.restore()},_calc_arrow:function(){var a=this.points,b=5*this.pen_width;this.arrow_info.idx=c.getPTPRange(a[0],a[1])>b?1:0,this.arrow_info.pos=c.calcArrow(a[0].x,a[0].y,a[1].x,a[1].y,b)},_doDraw:function(a,b){var c=this.points,d=this.arrow_info,e=d.pos,f=0===d.idx;a.beginPath(),f?(a.beginPath(),a.moveTo(e.ax,e.ay),a.lineTo(e.dx,e.dy),a.lineTo(e.bx,e.by),a.closePath(),a.fill()):(a.moveTo(c[0].x,c[0].y),a.lineTo(e.cx,e.cy),b?(a.lineTo(e.ax,e.ay),a.lineTo(e.dx,e.dy),a.lineTo(e.bx,e.by),a.lineTo(e.cx,e.cy),a.stroke()):(a.stroke(),a.closePath(),a.beginPath(),a.moveTo(e.ax,e.ay),a.lineTo(e.dx,e.dy),a.lineTo(e.bx,e.by),a.closePath(),a.save(),a.globalCompositeOperation="destination-out",a.fillStyle="black",a.fill(),a.restore(),a.fill()))},_calc:function(){this.callBase("_calc"),this._calc_arrow()},_doSelectDraw:function(a){this._doDraw(a,!0)},_doChooseDraw:function(a){this._doDraw(a,!1)}},c.inherit(a._LineArrowDoodle,a._LineDoodle),a._CurveArrowDoodle=function(a){this.arrow_info={idx:0,pos:{}},this.base(a)},a._CurveArrowDoodle.prototype={setPenWidth:function(a){this.callBase("setPenWidth",a),this._calc_arrow()},draw:function(a){var b=this.drawer,c=b.t_ctx,d=b.bg_info;c.save(),c.fillStyle=this.color,c.strokeStyle=this.color,c.lineWidth=this.pen_width,c.clearRect(d.x,d.y,d.width,d.height),this._doDraw(c),c.restore(),a.save(),a.setTransform(1,0,0,1,0,0),a.drawImage(c.canvas,0,0),a.restore()},_doDraw:function(a,b){var d=this.points,e=this.arrow_info,f=e.pos,g=0===e.idx;if(a.beginPath(),g)a.beginPath(),a.moveTo(f.cx,f.cy),a.lineTo(f.ax,f.ay),a.lineTo(f.dx,f.dy),a.lineTo(f.bx,f.by),a.closePath(),a.fill();else{var h=null,i=d[0];a.moveTo(i.x,i.y);for(var j=0;j<e.idx;j++)h=c.getMiddlePoint(d[j],d[j+1]),a.quadraticCurveTo(i.x,i.y,h.x,h.y),i=d[j+1];var k={x:f.cx,y:f.cy};h=c.getMiddlePoint(d[e.idx],k),a.quadraticCurveTo(i.x,i.y,h.x,h.y),i=k,h=k,a.quadraticCurveTo(i.x,i.y,h.x,h.y),b||(a.stroke(),a.closePath(),a.beginPath(),a.moveTo(f.cx,f.cy)),a.lineTo(f.ax,f.ay),a.lineTo(f.dx,f.dy),a.lineTo(f.bx,f.by),b?(a.lineTo(f.cx,f.cy),a.stroke()):(a.closePath(),a.save(),a.globalCompositeOperation="destination-out",a.fillStyle="black",a.fill(),a.restore(),a.fill())}},_calc:function(){this.callBase("_calc"),this._calc_arrow()},_calc_arrow:function(){var a=this.points,b=5*this.pen_width,d=a.length-1;if(!(0>=d)){for(var e=0;d>0&&(e=c.getPTPRange(a[a.length-1],a[d-1]),!(e>=b||1===d));)d--;this.arrow_info.idx=d-1,this.arrow_info.pos=c.calcArrow(a[d-1].x,a[d-1].y,a[a.length-1].x,a[a.length-1].y,b)}},_doSelectDraw:function(a){this._doDraw(a,!0)},_doChooseDraw:function(a){this._doDraw(a,!1)}},c.inherit(a._CurveArrowDoodle,a._CurveDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b,c){a._MatrixDoodle=function(a,b){1===b.points.length&&b.points.push({x:b.points[0].x,y:b.points[0].y}),this.base(a,b),this.matrix=null==b.matrix?[1,0,0,0,1,0,0,0,0]:b.matrix,this.line_type|=512,this.pre_matrix=c.copyArray(this.matrix),this.region_points=[],this.rotate_point={x:0,y:0},this.region_points=c.genPoints(b.region_number?b.region_number:4),this._calc(),this._create_edit_region()},a._MatrixDoodle.prototype={getRotatePoint:function(){return this.rotate_point},_create_edit_region:function(){for(var b=0;b<this.region_points.length;b++)this.edit_regions.push(new a.CircleRegion(this,b,this.region_points[b],Math.round((Math.max(this.pen_width,8)+6)/2),"pointer"))},getMoveUndoCommand:function(){return new b._DoodleMatrixCommand(this)},getRegionUndoCommand:function(){return new b._DoodlePointsCommand(this)},getRotateUndoCommand:function(){return new b._DoodleMatrixCommand(this)},_calcBeforeMatrixPoint:function(a,b,c){var d=a[3]*a[1]-a[0]*a[4];if(0===d)return alert("0"),console.error("出现除0！"),null;var e,f=((c-a[5])*a[1]-(b-a[2])*a[4])/d;if(0!==a[1])e=(b-a[2]-a[0]*f)/a[1];else{if(0===a[4])return alert("0"),console.error("出现除0~！"),null;e=(c-a[5]-a[3]*f)/a[4]}return{x:Math.floor(f),y:Math.floor(e)}},_calcBeforeMatrixWidth:function(a,b,c,d,e){var f=a[3]*a[1]-a[0]*a[4];if(0===f)return alert("0"),console.error("出现除0！"),-1;var g=((c-a[5])*a[1]-(b-a[2])*a[4])/f,h=((e-a[5])*a[1]-(d-a[2])*a[4])/f;return Math.abs(Math.floor(g-h))},_onRegionEdit:function(a,b,c){var d=this._calcBeforeMatrixPoint(this.matrix,b.x,b.y),e=d.x,f=d.y,g=c[0],h=c[1];if(8===this.region_points.length)switch(a){case 0:g.x=e,g.y=f;break;case 1:g.y=f;break;case 2:h.x=e,g.y=f;break;case 3:h.x=e;break;case 4:h.x=e,h.y=f;break;case 5:h.y=f;break;case 6:g.x=e,h.y=f;break;case 7:g.x=e}else switch(a){case 0:g.x=e,g.y=f;break;case 1:h.x=e,g.y=f;break;case 2:h.x=e,h.y=f;break;case 3:g.x=e,h.y=f}},onRegionEdit:function(a,b){this._onRegionEdit(a,b,this.points),this._calc(),this.drawer.edit_doodle.attachDoodle(this)},set_child_textbox:function(a){this.child_textbox=a,this._calc_boundary()},_calc_boundary:function(){var a=this.boundary,b=this.child_textbox.boundary;a.left=Math.min(a.left,b.left),a.right=Math.max(a.right,b.right),a.top=Math.min(a.top,b.top),a.bottom=Math.max(a.bottom,b.bottom)},_calc:function(){function a(a,b){return Math.floor(k[0]*a+k[1]*b+k[2])}function b(a,b){return Math.floor(k[3]*a+k[4]*b+k[5])}var c,d,e,f,g,h,i,j,k=this.matrix,l=this.points,m=(l[0].x+l[1].x)/2,n=(l[0].y+l[1].y)/2,o=Math.min(l[0].y,l[1].y)-this.pen_width/2-25;c=a(l[0].x,l[0].y),g=b(l[0].x,l[0].y),d=a(l[1].x,l[0].y),h=b(l[1].x,l[0].y),e=a(l[1].x,l[1].y),i=b(l[1].x,l[1].y),f=a(l[0].x,l[1].y),j=b(l[0].x,l[1].y);var p=this.region_points;8===p.length?(p[0].x=c,p[0].y=g,p[1].x=a(m,l[0].y),p[1].y=b(m,l[0].y),p[2].x=d,p[2].y=h,p[3].x=a(l[1].x,n),p[3].y=b(l[1].x,n),p[4].x=e,p[4].y=i,p[5].x=a(m,l[1].y),p[5].y=b(m,l[1].y),p[6].x=f,p[6].y=j,p[7].x=a(l[0].x,n),p[7].y=b(l[0].x,n)):(p[0].x=c,p[0].y=g,p[1].x=d,p[1].y=h,p[2].x=e,p[2].y=i,p[3].x=f,p[3].y=j),this.rotate_point.x=a(m,o),this.rotate_point.y=b(m,o),this._calc_2(Math.min(c,d,e,f),Math.min(g,h,i,j),Math.max(c,d,e,f),Math.max(g,h,i,j))},draw:function(a,b,c,d){this._typed_draw(a,b,c,d)},editStart:function(){c.setArray(this.pre_matrix,this.matrix),null!==this.child_textbox&&this.child_textbox.editStart()},editFinish:function(){this._calc(),null!==this.child_textbox&&(this.child_textbox.editFinish(),this._calc_boundary())},editMove:function(a,b){this.matrix[2]=this.pre_matrix[2]+a,this.matrix[5]=this.pre_matrix[5]+b,this._calc(),null!==this.child_textbox&&this.child_textbox.editMove()},move:function(a,b){this.matrix[2]+=a,this.matrix[5]+=b,this._calc()},rotateScale:function(a,b,d){c.setArray(this.pre_matrix,this.matrix),this.editRotateScale(a,b,d)},editRotateScale:function(a,b,c,d){c=1;var e=this.matrix,f=this.pre_matrix,g=Math.sin(b)*c,h=Math.cos(b)*c,i=a.x,j=a.y;e[0]=h*f[0]-g*f[3],e[1]=h*f[1]-g*f[4],e[2]=h*f[2]-g*f[5]-h*i+g*j+i,e[3]=g*f[0]+h*f[3],e[4]=g*f[1]+h*f[4],e[5]=g*f[2]+h*f[5]-g*i-h*j+j,d!==!0&&this._calc(),null!==this.child_textbox&&this.child_textbox.editRotateScale()},editPushPoint:function(a){this.points[1].x=a.x,this.points[1].y=a.y,this._calc()},setFillColor:function(a){return this.fill_color="string"!=typeof a?null:a,!0},resetZoomScale:function(){null!==this.child_textbox&&this.child_textbox.resetZoomScale()}},c.inherit(a._MatrixDoodle,a._Doodle),a._RectDoodle=function(b){this.base(a.Type.RECT,b)},a._RectDoodle.prototype={_doDraw:function(a,b){var c=this.points;a.save(),a.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),a.beginPath(),a.moveTo(c[0].x,c[0].y),a.lineTo(c[1].x,c[0].y),a.lineTo(c[1].x,c[1].y),a.lineTo(c[0].x,c[1].y),a.closePath(),null!==b&&(a.fillStyle=b,a.fill()),a.stroke(),a.restore()},_doChooseDraw:function(a,b){this._doDraw(a,null!==this.fill_color?b:null)},_doSelectDraw:function(a){this._doDraw(a,null)}},c.inherit(a._RectDoodle,a._MatrixDoodle),a._EllipseDoodle=function(b){this.center={x:0,y:0},this.radius={a:0,b:0},this.base(a.Type.ELLIPSE,b)},a._EllipseDoodle.prototype={_calc:function(){var a=this.points;this.center.x=Math.round((a[0].x+a[1].x)/2),this.center.y=Math.round((a[0].y+a[1].y)/2),this.radius.a=Math.round(Math.abs(a[0].x-a[1].x)/2),this.radius.b=Math.round(Math.abs(a[0].y-a[1].y)/2),this.callBase("_calc")},_doDraw:function(a,b){a.save(),a.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),c.drawEllipse(a,this.center.x,this.center.y,this.radius.a,this.radius.b,b),a.restore()},_doChooseDraw:function(a,b){this._doDraw(a,null!==this.fill_color?b:null)},_doSelectDraw:function(a){this._doDraw(a,null)}},c.inherit(a._EllipseDoodle,a._MatrixDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b,c,d){b._TextboxDoodle=function(c){1===c.points.length&&c.points.push({x:c.points[0].x,y:c.points[0].y}),this.base(b.Type.TEXT,c),this.editor=this.drawer.textbox_editor,this.matrix=[1,0,0,0,1,0,0,0,0],this.pre_matrix=d.copyArray(this.matrix),this.editor_matrix=d.copyArray(this.matrix),this.style=c.style?c.style:new a._Style(this.drawer.style),this.page_idx=this.editor.createPage(this.style),this.actived=!1,this.auto_width=c.auto_width!==!1,this.size={width:0,height:0},this.center={x:0,y:0},this.rotate_point={x:0,y:0},this._ur_timeout=null,this._ur_value=this.editor.getPageByIdx(this.page_idx).text,this._ur_handler=d.createDelegate(this,this._deal_ur),this._calc()},b._TextboxDoodle.prototype={afterUndoRedo:function(){this._calc(),this.actived?this.resetOutline():null!==this.drawer.cur_textbox&&this.drawer.cur_textbox!==this&&this.drawer.unactiveTextbox(),this.drawer._select_doodle(this)},getRotatePoint:function(){return this.rotate_point},getMoveUndoCommand:function(){return new c._DoodleMatrixCommand(this)},getRegionUndoCommand:function(){return new c._DoodlePointsCommand(this)},getRotateUndoCommand:function(){return new c._DoodleMatrixCommand(this)},setURText:function(a){var b=this.editor.getPageByIdx(this.page_idx);b.text=a,b.initParagraph(),this.actived&&(this.auto_width&&this._calc_text_outline(a),this.editor.textarea.value=a,this.editor.textarea.focus())},setColor:function(a){this.style.color=a,this.editor.textarea.style.color=this.style.color},setFontName:function(a){this.style.setFontName(a),this._resetFont()},setFontSize:function(a){this.style.setFontSize(a),this._resetFont()},_resetFont:function(){var a=this.style.getScaleFont(this.drawer.zoom_scale);if(this.actived)this.editor.cur_page.resetFont(),this.editor.textarea.style.font=a,this.editor.textarea.style.lineHeight=d.getFontInfo(a).height+"px",this.onTextInput(this.editor.textarea.value);else{var b=this.editor.getPageByIdx(this.page_idx);if(b.resetFont(),this.auto_width)this._calc_text_outline(b.text);else{var c=this.editor;c.save_state(),c._setCurPage(this.page_idx),b.initParagraph(),c.restore_state()}this.drawer.edit_doodle._re_attach_doodle(),this.drawer._paintEditLayer()}},initialize:function(){var a=this.points;if(a[1].y<a[0].y){var b=a[0];a[0]=a[1],a[1]=b}if(a[1].x<a[0].x){var c=a[0].x;a[0].x=a[1].x,a[1].x=c}var d=this.editor.getPageHeight(this.page_idx);this.auto_width?(this.size.width=20,this.size.height=d):(this.size.width=Math.max(20,a[1].x-a[0].x),this.size.height=Math.max(50,a[1].y-a[0].y)),this.matrix[2]=a[0].x,this.matrix[5]=a[0].y,a[0].x=0,a[0].y=0,a[1].x=this.size.width,a[1].y=this.size.height,this.initialized=!0,this._setAutoWidth(this.auto_width),this._calc(),this.resetOutline()},_setAutoWidth:function(a){this.editor.setBoxAutoWidth(a)},editStart:function(){d.setArray(this.pre_matrix,this.matrix)},editMove:function(a,b){this.matrix[2]=this.pre_matrix[2]+a,this.matrix[5]=this.pre_matrix[5]+b,this._calc()},move:function(a,b){this.matrix[2]+=a,this.matrix[5]+=b,this._calc()},rotateScale:function(a,b,c){d.setArray(this.pre_matrix,this.matrix),this.editRotateScale(a,b,c)},editRotateScale:function(a,b){this.is_rotating||(this.is_rotating=!0);var c=this.matrix,d=this.pre_matrix,e=Math.sin(b),f=Math.cos(b),g=a.x,h=a.y;c[0]=f*d[0]-e*d[3],c[1]=f*d[1]-e*d[4],c[2]=f*d[2]-e*d[5]-f*g+e*h+g,c[3]=e*d[0]+f*d[3],c[4]=e*d[1]+f*d[4],c[5]=e*d[2]+f*d[5]-e*g-f*h+h,this._calc(),this.actived&&(this.resetMatrix(),this._resetSize())},editPushPoint:function(){},_calc_editor_matrix:function(){var a=this.matrix,b=this.editor_matrix,c=this.drawer.zoom_scale,e=(this.center.x-this.drawer.bg_info.x)*c,f=(this.center.y-this.drawer.bg_info.y)*c,g=Math.sqrt(a[0]*a[4]-a[1]*a[3])*c;d.setArray(b,[1,0,0,0,1,0,0,0,0]),b[2]=e-this.size.width*g/2,b[5]=f-this.size.height*g/2;var h=Math.atan2(a[4],a[1])-Math.PI/2,i=Math.cos(h),j=Math.sin(h),k=i*b[0]-j*b[3],l=i*b[1]-j*b[4],m=i*b[2]-j*b[5]-i*e+j*f+e,n=j*b[0]+i*b[3],o=j*b[1]+i*b[4],p=j*b[2]+i*b[5]-j*e-i*f+f;b[0]=k,b[1]=l,b[2]=m,b[3]=n,b[4]=o,b[5]=p},resetScale:function(){this._calc_editor_matrix(),this.resetOutline(),this.resetFont()},resetFont:function(){var a=this.matrix,b=Math.sqrt(a[0]*a[4]-a[1]*a[3])*this.drawer.zoom_scale;this.editor.textarea.style.font=this.editor.cur_page.style.getScaleFont(b)},resetOutline:function(){this.actived&&(this._resetSize(),this.editor.setBoxMatrix(this.editor_matrix))},_resetSize:function(){var a=this.matrix,b=Math.sqrt(a[0]*a[4]-a[1]*a[3])*this.drawer.zoom_scale,c=this.size.width,d=this.size.height;this.editor.setBoxSize_scale(c,d,b)},_setDrawSize:function(){var a=this.matrix,b=Math.sqrt(a[0]*a[4]-a[1]*a[3])*this.drawer.zoom_scale,c=this.size.width,d=this.size.height;this.editor.set_drawtext_size(c,d,b)},_calc_text_outline:function(a){var b=this.editor,c=a.split("\n"),d=20,e=b.render.ctx,f=this.points;e.save(),e.font=b.cur_page.style.font;for(var g=0;g<c.length;g++){var h=e.measureText(c[g]).width;h>d&&(d=h)}e.restore();var i=b.cur_page.line_height*c.length;this.size.width=Math.ceil(d)+5,this.size.height=Math.ceil(i),f[1].x=this.size.width,f[1].y=this.size.height,this._resetSize(),this._calc()},onTextInput:function(a){this.auto_width&&(this._calc_text_outline(a),this.drawer.edit_doodle._re_attach_doodle(),this.drawer._paintEditLayer())},resetMatrix:function(){this.setBoxMatrix(this.editor_matrix)},setBoxMatrix:function(a){this.editor.setBoxMatrix(a)},_calc:function(a){var b,c,d,e,f,g,h,i,j=this.matrix,k=this.points,l=(k[0].x+k[1].x)/2,m=Math.min(k[0].y,k[1].y)-20;b=j[0]*k[0].x+j[1]*k[0].y+j[2],f=j[3]*k[0].x+j[4]*k[0].y+j[5],c=j[0]*k[1].x+j[1]*k[0].y+j[2],g=j[3]*k[1].x+j[4]*k[0].y+j[5],d=j[0]*k[1].x+j[1]*k[1].y+j[2],h=j[3]*k[1].x+j[4]*k[1].y+j[5],e=j[0]*k[0].x+j[1]*k[1].y+j[2],i=j[3]*k[0].x+j[4]*k[1].y+j[5];var n=(k[0].x+k[1].x)/2,o=(k[0].y+k[1].y)/2;this.center.x=Math.floor(j[0]*n+j[1]*o+j[2]),this.center.y=Math.floor(j[3]*n+j[4]*o+j[5]),this.rotate_point.x=Math.floor(j[0]*l+j[1]*m+j[2]),this.rotate_point.y=Math.floor(j[3]*l+j[4]*m+j[5]),this._calc_2(Math.min(b,c,d,e),Math.min(f,g,h,i),Math.max(b,c,d,e),Math.max(f,g,h,i)),a||this._calc_editor_matrix()},_deal_ur:function(){var a=this.editor.textarea.value;this._ur_value!==a&&(this.drawer.history.add(new c._DoodleTextCommand(this,this._ur_value,a)),this._ur_value=a)},onTextPress:function(){null!==this._ur_timeout&&window.clearTimeout(this._ur_timeout),this._ur_timeout=window.setTimeout(this._ur_handler,300)},active:function(){this._doActive(),this.editor.textarea.style.color=this.style.color},_doActive:function(){this.actived=!0,this.drawer.paint(),this.editor.floated_textbox=this,this.editor.setCurPage(this.page_idx),this._setAutoWidth(this.auto_width),this.resetOutline();var a=this.editor;a.show(),a.focus()},unactive:function(){this.actived=!1;var a=this.editor;a.blur(),a.hide(),""===a.textarea.value.trim()?this.drawer.delTextbox(this):(a.cur_page.text=a.textarea.value,a.cur_page.initParagraph())},_doDraw:function(a,b,c){var e=this.points;a.save(),a.lineWidth=2,d.setLineDash(a,[6,5]),a.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),a.beginPath(),a.moveTo(e[0].x,e[0].y),a.lineTo(e[1].x,e[0].y),a.lineTo(e[1].x,e[1].y),a.lineTo(e[0].x,e[1].y),a.closePath(),b?(a.fillStyle=b,a.fill()):c&&(a.strokeStyle=c,a.stroke()),a.restore()},draw_select:function(a){this.actived||this._draw_text(a),this._doDraw(a,null,this.style.color)},_doChooseDraw:function(a,b){this._doDraw(a,b,null)},_draw_text:function(a){var b=this.editor_matrix,c=this.editor;c.save_state(),a.save(),a.setTransform(1,0,0,1,0,0),a.transform(b[0],b[3],b[1],b[4],b[2],b[5]),c._setCurPage(this.page_idx),this._setDrawSize(),this.editor.render.paintToContext(a,this.style),a.restore(),c.restore_state()},draw:function(a){this.initialized?this.actived?this.actived&&this._doDraw(a,null,this.style.color):this._draw_text(a):this._doDraw(a,null,this.style.color)}},d.inherit(b._TextboxDoodle,b._Doodle)}(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b){a._RectBlurDoodle=function(c){1===c.points.length&&c.points.push({x:c.points[0].x,y:c.points[0].y}),c.pen_width=2,c.region_points=b.genPoints(4),this.base(a.Type.RECT_BLUR,c),this._create_edit_region()},a._RectBlurDoodle.prototype={onRegionEdit:function(a,b){var c=b.x,d=b.y,e=this.points[0],f=this.points[1];switch(a){case 0:e.x=c,e.y=d;break;case 1:f.x=c,e.y=d;break;case 2:f.x=c,f.y=d;break;case 3:e.x=c,f.y=d}this._calc()},_calc:function(){var a=this.points,b=this.region_points;b[0].x=a[0].x,b[0].y=a[0].y,b[1].x=a[1].x,b[1].y=a[0].y,b[2].x=a[1].x,b[2].y=a[1].y,b[3].x=a[0].x,b[3].y=a[1].y,this._calc_1(this.points)},draw:function(a){var c=this.boundary,d=this.drawer.zoom_scale,e=this.drawer.bg_info.x,f=this.drawer.bg_info.y,g=Math.floor((c.left-e)*d),h=Math.floor((c.top-f)*d),i=Math.floor(c.width*d),j=Math.floor(c.height*d);i>0&&j>0&&b.stackBlurCanvasRGBA(a,g,h,i,j,Math.floor(7*this.drawer.zoom_scale))},draw_blur:function(a){var c=this.drawer.b_ctx;a.save(),a.setTransform(1,0,0,1,0,0),c.save(),c.setTransform(1,0,0,1,0,0);var d=this.boundary,e=this.drawer.zoom_scale,f=this.drawer.bg_info.x,g=this.drawer.bg_info.y,h=Math.floor((d.left-f)*e),i=Math.floor((d.top-g)*e),j=Math.floor(d.width*e),k=Math.floor(d.height*e);j>0&&k>0&&(c.drawImage(this.drawer.doodle_canvas,h,i,j,k,h,i,j,k),b.stackBlurCanvasRGBA(c,h,i,j,k,Math.floor(7*this.drawer.zoom_scale)),a.drawImage(this.drawer.blur_canvas,h,i,j,k,h,i,j,k)),a.restore(),c.restore(),a.strokeStyle="rgba(0, 0, 0, 0.6)",a.lineWidth=Math.floor(2*e),b.setLineDash(a,[4*e,4*e]),this._doDraw(a)},_doDraw:function(a,b){var c=this.points;a.save(),a.beginPath(),a.moveTo(c[0].x,c[0].y),a.lineTo(c[1].x,c[0].y),a.lineTo(c[1].x,c[1].y),a.lineTo(c[0].x,c[1].y),a.closePath(),b&&(a.fillStyle=b,a.fill()),a.stroke(),a.restore()},_doChooseDraw:function(a,b){this._doDraw(a,b)},draw_select:function(a){this.draw_blur(a,this.drawer.blur_canvas)},editPushPoint:function(a){this.points[1].x=a.x,this.points[1].y=a.y,this._calc()}},b.inherit(a._RectBlurDoodle,a._CommonDoodle)}(Diigo.Doodle,Diigo.$),function(a,b,c){a._CutDoodle=function(b){1===b.points.length&&b.points.push({x:b.points[0].x,y:b.points[0].y}),this.base(a.Type.CUT,b),this.pre_points=c.copyPoints(this.points),this.region_points=c.genPoints(8),this.dash_value=[3,3],this.resetScale(),this._create_edit_region(),this.__point_in__=!1},a._CutDoodle.prototype={setSize:function(a,b){var c=this.points[0],d=this.points[1];c.x<d.x?d.x=c.x+a:c.x=d.x+a,c.y<d.y?d.y=c.y+b:c.y=d.y+b,this._calc()},_size_callback:function(){var a=this.points,b=Math.abs(a[1].x-a[0].x),c=Math.abs(a[1].y-a[0].y),d=Math.min(a[0].x,a[1].x),e=Math.min(a[0].y,a[1].y),f=this.drawer.bg_info,g=f.x+f.width-d,h=f.y+f.height-e;this.drawer.style_callback("crop",{left:d,top:e,width:b,height:c,max_width:g,max_height:h})},checkPointIn:function(a,b){var c=this.boundary,d=10,e=a>=c.left+d&&a<=c.right-d&&b>=c.top+d&&b<=c.bottom+d;e&&!this.__point_in__?(this.__point_in__=!0,this.drawer.setCursor_name("cursor_move")):!e&&this.__point_in__&&(this.__point_in__=!1,this.drawer.setCursor_name("cursor_default"))},onRegionEdit:function(a,b){var c=b.x,d=b.y,e=this.points[0],f=this.points[1];switch(a){case 0:e.x=c,e.y=d;break;case 1:e.y=d;break;case 2:f.x=c,e.y=d;break;case 3:f.x=c;break;case 4:f.x=c,f.y=d;break;case 5:f.y=d;break;case 6:e.x=c,f.y=d;break;case 7:e.x=c}this._calc(),this._size_callback()},resetScale:function(){var a=Math.round(3*this.drawer.zoom_scale);this.dash_value[0]=a,this.dash_value[1]=a},_calc:function(){var a=this.points,b=this.region_points;b[0].x=a[0].x,b[0].y=a[0].y,b[1].x=Math.floor((a[0].x+a[1].x)/2),b[1].y=a[0].y,b[2].x=a[1].x,b[2].y=a[0].y,b[3].x=a[1].x,b[3].y=Math.floor((a[0].y+a[1].y)/2),b[4].x=a[1].x,b[4].y=a[1].y,b[5].x=Math.floor((a[0].x+a[1].x)/2),b[5].y=a[1].y,b[6].x=a[0].x,b[6].y=a[1].y,b[7].x=a[0].x,b[7].y=Math.floor((a[0].y+a[1].y)/2),this._calc_1(this.points)},editPushPoint:function(a){this.points[1].x=a.x,this.points[1].y=a.y,this._calc(),this._size_callback()},_create_edit_region:function(){for(var b=0;b<this.region_points.length;b++)this.edit_regions.push(new a.CircleRegion(this,b,this.region_points[b],7,"pointer"))},editMove:function(a,b){for(var c=0;c<this.points.length;c++)this.points[c].x=this.pre_points[c].x+a,this.points[c].y=this.pre_points[c].y+b;this._calc()},move:function(a,b){for(var c=0;c<this.points.length;c++)this.points[c].x+=a,this.points[c].y+=b;this._calc()},editStart:function(){c.setPoints(this.pre_points,this.points)},editFinish:function(){this._calc(),this._size_callback()},draw:function(a){var b=this.points;a.save(),c.setLineDash(a,this.dash_value),a.beginPath(),a.moveTo(b[0].x,b[0].y),a.lineTo(b[1].x,b[0].y),a.lineTo(b[1].x,b[1].y),a.lineTo(b[0].x,b[1].y),a.closePath(),a.save(),a.fillStyle="black",a.globalCompositeOperation="destination-out",a.fill(),a.restore(),a.strokeStyle="rgba(0, 128, 255, 0.9)",a.lineWidth=Math.floor(2/this.drawer.zoom_scale),a.stroke(),a.restore()},_doDraw:function(a){var b=this.points;a.beginPath(),a.moveTo(b[0].x,b[0].y),a.lineTo(b[1].x,b[0].y),a.lineTo(b[1].x,b[1].y),a.lineTo(b[0].x,b[1].y),a.closePath(),a.fill()}},c.inherit(a._CutDoodle,a._Doodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b,c){var d="Arial";a._ListDoodle=function(b){this.center=b.points[0];var d=a._ListDoodle.__LAST_INFO__;b.color=d.color,b.points=[{x:0,y:0},{x:0,y:0}],this.radius={a:d.radius.a,b:d.radius.b},this._calc_points(b.points),this.i_value=d.getValue(),this.i_type=d.i_type,this.i_str="",this._get_i_str();var e=c.str2rgba(b.color),f=.299*e.r+.587*e.g+.114*e.b;this.font_color=f>200?c.rgba2str(0,0,0,e.a):c.rgba2str(255,255,255,e.a),this.border_color=c.rgba2str(255,255,255,e.a),this.font="",this.base(a.Type.LIST,b),this._pre_rp={x:0,y:0}},a._ListDoodle.__LAST_INFO__={radius:{a:20,b:20},i_type:"number",i_value:1,color:"#000",cursor_cache:{},getValue:function(){return this.i_value++},getCursor:function(){var a=this.cursor_cache[this.i_value];return"undefined"==typeof a&&(a=c.getListCursor(this.i_value),this.cursor_cache[this.i_value]=a),a},reset:function(){this.i_type="number",this.i_value=1,this.radius.a=20,this.radius.b=20}},a._ListDoodle.__WIDTH_CACHE__={w_table:{},h_table:{},get_w:function(a,b,c){var e=this.w_table[a];"undefined"==typeof e&&(e={},this.w_table[a]=e);var f=e[b];return"undefined"==typeof f&&(c.save(),c.font=b+"px "+d,f=c.measureText(a).width,c.restore(),e[b]=f),f},get_h:function(a){var b=this.h_table[a];return"undefined"==typeof b&&(b=Math.floor(c.getFontInfo(a+"px "+d).height),this.h_table[a]=b),b
}},a._ListDoodle.prototype={setPenWidth:function(){},setColor:function(a){this.color=a;var b=c.str2rgba(this.color),d=.299*b.r+.587*b.g+.114*b.b;this.font_color=d>200?c.rgba2str(0,0,0,b.a):c.rgba2str(255,255,255,b.a),this.border_color=c.rgba2str(255,255,255,b.a)},set_i_value:function(a){this.i_value=a,this._get_i_str(),this._calc_font(),this.drawer._paintEditLayer()},_get_i_str:function(){switch(this.i_type){case"number":this.i_str=this.i_value.toString()}},_calc_font:function(){function b(a,b,c){for(var d=Math.floor((b+a)/2),e="w"===c?h:i;;){if(1>=b-d)return d;var f="w"===c?g.get_w(k,d,l):g.get_h(d);if(f>e)b=d;else{if(!(e>f))return d;a=d}d=Math.floor((b+a)/2)}}for(var c=Math.asin(1)/2,e=this.radius.a*Math.cos(c),f=this.radius.b*Math.sin(c),g=a._ListDoodle.__WIDTH_CACHE__,h=Math.floor(2*e),i=Math.floor(2*f),j=100,k=this.i_str,l=this.drawer.t_ctx;g.get_w(k,j,l)<h&&g.get_h(j)<i;)j*=2;g.get_w(k,j,l)>h&&(j=b(1,j,"w")),g.get_h(j)>i&&(j=b(1,j,"h")),this.font=j+"px "+d},_calc_points:function(a){var b=this.center,c=this.radius;a[0].x=b.x-c.a,a[0].y=b.y-c.b,a[1].x=b.x+c.a,a[1].y=b.y+c.b},onRegionEdit:function(a,b){var c=this.points;this._onRegionEdit(a,b,c);var d=Math.round(Math.abs(c[0].x-c[1].x)/2),e=Math.round(Math.abs(c[0].y-c[1].y)/2);this.radius.a=this.radius.b=Math.min(d,e),this._calc_points(this.points),this._calc(),this.drawer.edit_doodle.attachDoodle(this)},onRegionEditStart:function(a,b){this._pre_rp.x=b.x,this._pre_rp.y=b.y},onRegionEditFinish:function(){var b=a._ListDoodle.__LAST_INFO__;b.radius.a=this.radius.a,b.radius.b=this.radius.b},_calc:function(){var a=this.points;this.center.x=Math.round((a[0].x+a[1].x)/2),this.center.y=Math.round((a[0].y+a[1].y)/2),this.radius.a=Math.round(Math.abs(a[0].x-a[1].x)/2),this.radius.b=Math.round(Math.abs(a[0].y-a[1].y)/2),this.callBase("_calc"),this._calc_font()},_doDraw:function(a,b){a.save(),a.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),c.drawEllipse(a,this.center.x,this.center.y,this.radius.a,this.radius.b,b),a.restore()},draw:function(a){var b=this.center.x,c=this.center.y,d=this.radius.a,e=this.radius.b;a.save(),a.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),a.save(),a.fillStyle=this.border_color,a.lineWidth=4,a.shadowColor="rgba(0, 0, 0, 0.4)",a.shadowOffsetX=0,a.shadowOffsetY=2,a.shadowBlur=4,a.beginPath(),a.ellipse(b,c,d+4,e+4,0,0,2*Math.PI,0),a.closePath(),a.fill(),a.restore(),a.fillStyle=this.color,a.beginPath(),a.ellipse(b,c,d,e,0,0,2*Math.PI,0),a.closePath(),a.fill(),a.font=this.font,a.fillStyle=this.font_color,a.textAlign="center",a.textBaseline="middle",a.fillText(this.i_str,this.center.x,this.center.y),a.restore()},_doChooseDraw:function(a,b){this._doDraw(a,b)},_doSelectDraw:function(){},editPushPoint:function(){}},c.inherit(a._ListDoodle,a._MatrixDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b,c){a._BezierArrowDoodle=function(b){1===b.points.length?b.points.push({x:0,y:0},{x:0,y:0},{x:b.points[0].x,y:b.points[0].y}):2===b.points.length&&b.points.splice(1,0,{x:0,y:0},{x:0,y:0}),this.rotate_point={x:0,y:0},this.arrow_info={idx:0,pos:{}},this.base(a.Type.BEZIER_ARROW,b),this.region_points=this.points,this._create_edit_region()},a._BezierArrowDoodle.prototype={setPenWidth:function(a){this.callBase("setPenWidth",a),this._calc_arrow()},_calc:function(){this._calc_1(this.points),this._calc_arrow()},draw:function(a){var b=this.drawer.t_ctx,c=this.drawer.bg_info;b.save(),b.fillStyle=this.color,b.strokeStyle=this.color,b.lineWidth=this.pen_width,b.clearRect(c.x,c.y,c.width,c.height),this._doDraw(b),b.restore(),a.save(),a.setTransform(1,0,0,1,0,0),a.drawImage(b.canvas,0,0),a.restore()},_calc_arrow:function(){var a=this.points,b=5*this.pen_width;this.arrow_info.idx=c.getPTPRange(a[0],a[3])>b?1:0,this.arrow_info.pos=c.calcArrow(a[2].x,a[2].y,a[3].x,a[3].y,b)},_doDraw:function(a,b){var c=this.points,d=this.arrow_info,e=d.pos,f=0===d.idx;a.beginPath(),f?(a.beginPath(),a.moveTo(e.ax,e.ay),a.lineTo(e.dx,e.dy),a.lineTo(e.bx,e.by),a.closePath(),a.fill()):(a.moveTo(c[0].x,c[0].y),a.bezierCurveTo(c[1].x,c[1].y,c[2].x,c[2].y,d.pos.cx,d.pos.cy),b?(a.lineTo(e.ax,e.ay),a.lineTo(e.dx,e.dy),a.lineTo(e.bx,e.by),a.lineTo(e.cx,e.cy),a.stroke()):(a.stroke(),a.closePath(),a.beginPath(),a.moveTo(e.ax,e.ay),a.lineTo(e.dx,e.dy),a.lineTo(e.bx,e.by),a.closePath(),a.save(),a.globalCompositeOperation="destination-out",a.fillStyle="black",a.fill(),a.restore(),a.fill()))},_doSelectDraw:function(a){var b=this.points;a.save(),a.lineWidth=2,c.setLineDash(a,[8,5]),a.strokeStyle=this.highlight_color,a.shadowBlur=3,a.shadowColor="rgba(0,0,0,0.4)",a.shadowOffsetX=0,a.shadowOffsetY=1,a.beginPath(),a.moveTo(b[0].x,b[0].y),a.lineTo(b[1].x,b[1].y),a.lineTo(b[2].x,b[2].y),a.lineTo(b[3].x,b[3].y),a.stroke(),a.closePath(),a.restore(),this._doDraw(a,!0)},_doChooseDraw:function(a){this._doDraw(a,!1)},editPushPoint:function(a){var b=this.points;b[3].x=a.x,b[3].y=a.y;var c=Math.floor((b[3].x-b[0].x)/3),d=Math.floor((b[3].y-b[0].y)/3);b[1].x=b[0].x+c,b[1].y=b[0].y+d,b[2].x=b[1].x+c,b[2].y=b[1].y+d,this._calc()},getRegionUndoCommand:function(){return new b._DoodlePointsCommand(this)},onRegionEdit:function(a,b){this.points[a].x=b.x,this.points[a].y=b.y,this._calc(),this.drawer.edit_doodle.attachDoodle(this)},onRegionEditFinish:function(){this.drawer.edit_doodle.attachDoodle(this)}},c.inherit(a._BezierArrowDoodle,a._CommonDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b,c){a._AnnotationDoodle=function(a,b){this.base(a,b),this.matrix=null==b.matrix?[1,0,0,0,1,0,0,0,0]:b.matrix,this.pre_matrix=c.copyArray(this.matrix),this.pre_points=c.copyPoints(this.points),this.rotate_point={x:0,y:0},this.svg_width=b.svg_info.width,this.svg_height=b.svg_info.height,this.svg_shapes=b.svg_info.shapes,this._pre_svg(),this.pre_svg_shapes=this._copy_svg_shapes(),this.region_points=c.genPoints(8),this._calc(),this._create_edit_region()},a._AnnotationDoodle.prototype={_copy_svg_shapes:function(){for(var a=[],b=0;b<this.svg_shapes.length;b++){for(var d=this.svg_shapes[b],e={type:d.type,cmd_arr:[]},f=0;f<d.cmd_arr.length;f++){var g=d.cmd_arr[f];e.cmd_arr.push({command:g.command,points:c.copyArray(g.points)})}a.push(e)}return a},_pre_svg:function(){for(var a=0;a<this.svg_shapes.length;a++){var b=this.svg_shapes[a];"path"===b.type&&(b.cmd_arr=c.parseSVGPath(b.data))}},_create_edit_region:function(){for(var b=["nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"],c=0;c<this.region_points.length;c++)this.edit_regions.push(new a.CircleRegion(this,c,this.region_points[c],7,b[c]))},onRegionEdit:function(a,b){var c=b.x,d=b.y,e=this.points[0],f=this.points[1];switch(a){case 0:e.x=c,e.y=d;break;case 1:e.y=d;break;case 2:f.x=c,e.y=d;break;case 3:f.x=c;break;case 4:f.x=c,f.y=d;break;case 5:f.y=d;break;case 6:e.x=c,f.y=d;break;case 7:e.x=c}this._calc()},_calc:function(){var a=this.points,b=this.region_points;b[0].x=a[0].x,b[0].y=a[0].y,b[1].x=Math.floor((a[0].x+a[1].x)/2),b[1].y=a[0].y,b[2].x=a[1].x,b[2].y=a[0].y,b[3].x=a[1].x,b[3].y=Math.floor((a[0].y+a[1].y)/2),b[4].x=a[1].x,b[4].y=a[1].y,b[5].x=Math.floor((a[0].x+a[1].x)/2),b[5].y=a[1].y,b[6].x=a[0].x,b[6].y=a[1].y,b[7].x=a[0].x,b[7].y=Math.floor((a[0].y+a[1].y)/2),this._calc_1(this.points),this._calc_svg();var c=this.boundary;this.rotate_point.x=Math.floor(c.left+c.width/2),this.rotate_point.y=c.top-20},_calc_svg:function(){for(var a,b,c,d,e,f,g=this.points,h=Math.min(g[0].x,g[1].x),i=Math.min(g[0].y,g[1].y),j=Math.abs(g[0].x-g[1].x),k=Math.abs(g[0].y-g[1].y),l=j/this.svg_width,m=k/this.svg_height,n=0;n<this.svg_shapes.length;n++)if(a=this.svg_shapes[n],d=this.pre_svg_shapes[n],"path"===a.type){b=a.cmd_arr,e=d.cmd_arr;for(var o=0;o<b.length;o++){c=b[o].points,f=e[o].points;for(var p=0;p<c.length;p+=2)c[p]=h+f[p]*l,c[p+1]=i+f[p+1]*m}}},_draw_path:function(a,b){a.save(),a.beginPath();for(var c,d,e=b.cmd_arr,f=0;f<e.length;f++)switch(c=e[f],d=c.points,c.command){case"M":a.moveTo(d[0],d[1]);break;case"C":a.bezierCurveTo(d[0],d[1],d[2],d[3],d[4],d[5]);break;case"Q":a.quadraticCurveTo(d[0],d[1],d[2],d[3]);break;case"L":a.lineTo(d[0],d[1]);break;case"Z":a.closePath()}a.fill(),a.restore()},_doDraw:function(a,b){a.fillStyle=b;for(var c=0;c<this.svg_shapes.length;c++){var d=this.svg_shapes[c];switch(d.type){case"path":this._draw_path(a,d)}}},draw_select:function(a){a.save(),a.restore()},draw:function(a){var b=this.points;a.save(),a.lineWidth=3,a.lineCap="round",a.lineJoin="round",a.fillStyle=this.color,this._doDraw(a),this.initialized||(a.strokeStyle="black",a.beginPath(),a.moveTo(b[0].x,b[0].y),a.lineTo(b[1].x,b[0].y),a.lineTo(b[1].x,b[1].y),a.lineTo(b[0].x,b[1].y),a.closePath(),a.stroke()),a.restore()},editStart:function(){c.setPoints(this.pre_points,this.points)},editMove:function(a,b){for(var c=0;c<this.points.length;c++)this.points[c].x=this.pre_points[c].x+a,this.points[c].y=this.pre_points[c].y+b;this._calc()},editRotateScale:function(a,b,c,d){for(var e=0;e<this.points.length;e++){var f=this.pre_points[e].x-a.x,g=this.pre_points[e].y-a.y;this.points[e].x=Math.round(f+a.x),this.points[e].y=Math.round(g+a.y),this.points[e].x=Math.round(f*Math.cos(b)-g*Math.sin(b)+a.x),this.points[e].y=Math.round(f*Math.sin(b)+g*Math.cos(b)+a.y)}d!==!0&&this._calc()},rotateScale:function(a,b,d){c.setPoints(this.pre_points,this.points),this.editRotateScale(a,b,d)},editPushPoint:function(a){var b,c,d=this.points[0],e=this.points[1],f=a.x-d.x,g=Math.abs(f),h=a.y-d.y,i=Math.abs(h),j=g/this.svg_width,k=i/this.svg_height,l=this.svg_width/this.svg_height;j>k?(c=i,b=i*l):(b=g,c=g/l),e.x=d.x+Math.floor(f>0?b:-b),e.y=d.y+Math.floor(h>0?c:-c),this._calc()}},c.inherit(a._AnnotationDoodle,a._Doodle),a._Annotation_A_Doodle=function(b){b.svg_info={width:351.712,height:561.438,shapes:[{type:"path",data:"M333.184,374.484c-11.569,17.688-28.387,33.211-48.997,44.933c31.007,68.849,60.356,136.001,59.616,141.905c0,0.081-0.039,0.081-0.06,0.161L277.16,423.179c-0.81,0.404-1.548,0.891-2.367,1.253c23.594,49.353,46.428,96.923,60.071,124.311c-14.724-24.595-40.957-72.452-66.706-121.235c-13.298,5.662-26.84,9.465-40.189,11.124c-49.877,6.311-96.65-14.281-114.895-54.802c-10.205-22.735-0.242-32.667,15.908-57.181L89.398,162.948c-24.452,1.975-51.909-15.158-68.576-29.973c39.715,11.7,76.577,2.669,101.19-7.718c3.49,5.827,13.341,22.33,14.583,24.858c15.667-6.704,27.64-14.622,35.589-21.014l-0.042-0.081l-7.322-28.772c17.072-13.229,30.471-28.409,38.016-43.164c-0.181,18.983-3.438,43.286-15.168,56.846c0,0,65.674,100.017,92.795,142.089c30.359,3.458,53.105,0.628,63.682,24.089C357.74,310.327,352.379,345.033,333.184,374.484z M174.703,133.701c-8.223,6.514-20.298,14.412-36.023,21.147l89.167,209.149c7.059-2.326,14.018-5.036,20.429-8.464c13.724-7.353,24.716-16.979,32.463-27.903L174.703,133.701z M329.22,358.949l-45.001-27.314c-8.174,11.164-19.499,20.975-33.495,28.468c-6.745,3.6-14.067,6.431-21.491,8.868l-1.021,53.196l-0.021,0.404c11.872-2.59,23.887-6.514,35.821-11.853c27.893-12.528,50.484-30.795,65.411-51.019L329.22,358.949z M133.776,114.123c-23.767,12.408-71.084,30.26-121.235,10.941c-4.207-3.407-7.626-7.392-9.769-12.176c-2.316-5.208-3.116-10.891-2.639-16.818C2.449,68.886,33,36.121,77.598,16.076c44.609-20.003,89.4-21.055,111.234-4.743c4.795,3.582,8.464,7.948,10.822,13.158c2.337,5.216,3.144,10.892,2.639,16.848c0.081,0.92,0.122,2.063,0.182,3.073C195.253,68.2,167.614,96.466,133.776,114.123z"}]},this.base(a.Type.ANNOTATION_A,b)},c.inherit(a._Annotation_A_Doodle,a._AnnotationDoodle),a._Annotation_B_Doodle=function(b){b.svg_info={width:412.827,height:435.695,shapes:[{type:"path",data:"M121.917,0.016c-8.358-0.696-33.496,20.935-25.586,54.895c7.908,33.959,38.146,65.593,40.938,83.737c2.791,18.143,2.791,37.216-25.122,40.007c-27.912,2.792-46.056-2.791-65.129-3.257c-19.073-0.465-46.056,10.7-46.986,33.496c-0.93,22.794,18.609,32.564,18.609,32.564S4.219,253.553,5.15,274.487c0.93,20.935,17.213,31.634,17.213,31.634s-11.629,28.843-1.861,41.404c9.77,12.56,21.4,18.143,21.4,18.143s-2.791,27.912,8.374,39.078c11.165,11.165,33.293,36.354,134.91,20.003c27.748-4.465,75.363-14.422,75.363-14.422s54.428-141.139,54.428-187.478c0-0.466-21.918-23.766-31.168-43.729c-8.84-19.073-38.893-48.101-73.969-72.572C169.833,78.636,127.499,0.481,121.917,0.016z"},{type:"path",data:"M330.329,225.177c0,0-32.292,147.129-53.964,174.453c-5.38,6.782,0.466,24.19,6.978,26.981c6.513,2.791,37.217,13.026,55.36,7.444c18.143-5.583,56.29-83.737,60.012-103.741c3.721-20.005,18.143-84.668,13.026-98.159C406.622,218.663,333.585,214.476,330.329,225.177z"}]},this.base(a.Type.ANNOTATION_B,b)},c.inherit(a._Annotation_B_Doodle,a._AnnotationDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b){a._Command=function(){},a._Command.prototype={undo:function(){throw"abstract method"},redo:function(){throw"abstract method"},toString:function(){return"undo-redo-command"},finish:function(){}},a._CombineCommand=function(){this.cmd_array=[]},a._CombineCommand.prototype={add:function(a){this.cmd_array.push(a)},undo:function(){for(var a=this.cmd_array.length-1;a>=0;a--)this.cmd_array[a].undo()},redo:function(){for(var a=0;a<this.cmd_array.length;a++)this.cmd_array[a].redo()},toString:function(){return this.cmd_array.join(",")},finish:function(){for(var a=this.cmd_array.length-1;a>=0;a--)this.cmd_array[a].finish()}},b.inherit(a._CombineCommand,a._Command),a._UndoRedoManager=function(a){this.drawer=a,this.cmd_array=[],this.cmd_index=-1,this.cmd_size=0,this.MAX_NUM=99999999},a._UndoRedoManager.prototype={add:function(a){this.cmd_index+1<this.MAX_NUM?(this.cmd_index++,this.cmd_array[this.cmd_index]=a,this.cmd_size=this.cmd_index+1):(this.cmd_array.shift(),this.cmd_array.push(a)),this.drawer._ur_back()},undo:function(){this.cmd_index>=0&&(this.cmd_array[this.cmd_index--].undo(),this.drawer.paint(),this.drawer._ur_back())},canUndo:function(){return this.cmd_index>=0},canRedo:function(){return this.cmd_index+1<this.cmd_size},redo:function(){this.cmd_index+1<this.cmd_size&&(this.cmd_array[++this.cmd_index].redo(),this.drawer.paint(),this.drawer._ur_back())},reset:function(){this.cmd_index=-1,this.cmd_size=0,this.cmd_array.length=0,this.drawer._ur_back()},clear:function(){this.reset()}},a._DoodleCalloutCommand=function(a){this.doodle=a,this.ps=b.copyPoints(a.points),this.cs=b.copyPoints(this.ps),this.pa={x:a.a_info.point.x,y:a.a_info.point.y},this.ca={x:0,y:0}},a._DoodleCalloutCommand.prototype={_v:function(a,c){b.setPoints(this.doodle.points,a),this.doodle.a_info.point.x=c.x,this.doodle.a_info.point.y=c.y,this.doodle.afterUndoRedo()},undo:function(){this._v(this.ps,this.pa)},redo:function(){this._v(this.cs,this.ca)},finish:function(){b.setPoints(this.cs,this.doodle.points),this.ca.x=this.doodle.a_info.point.x,this.ca.y=this.doodle.a_info.point.y}},b.inherit(a._DoodleCalloutCommand,a._Command),a._DoodleTextCommand=function(a,b,c){this.doodle=a,this.ps=b,this.cs=c},a._DoodleTextCommand.prototype={_v:function(a){this.doodle.setURText(a),this.doodle.afterUndoRedo()},undo:function(){this._v(this.ps)},redo:function(){this._v(this.cs)}},b.inherit(a._DoodleTextCommand,a._Command),a._CropCommand=function(a){this.drawer=a;var b=this.drawer.bg_info;this.ps={x:b.x,y:b.y,w:b.width,h:b.height},this.cs=null},a._CropCommand.prototype={_v:function(a){this.drawer.set_bg_info(a)},undo:function(){this._v(this.ps)},redo:function(){this._v(this.cs)},finish:function(){var a=this.drawer.bg_info;this.cs={x:a.x,y:a.y,w:a.width,h:a.height}}},b.inherit(a._CropCommand,a._Command),a._SizeCommand=function(a){this.drawer=a;var b=this.drawer.bg_info;this.img=document.createElement("canvas"),this.ps={x:b.x,y:b.y,width:b.width,height:b.height},this.ds=[],this.cs=null,this._init()},a._SizeCommand.prototype={_init:function(){var a=this.img.getContext("2d");this.img.width=this.drawer.image_canvas.width,this.img.height=this.drawer.image_canvas.height,a.drawImage(this.drawer.image_canvas,0,0),[].push.apply(this.ds,this.drawer.page.doodle_array)},undo:function(){this.drawer._set_image_size_undo(this.img,this.ps,this.ds)},redo:function(){this.drawer._set_image_size_redo(this.cs.width,this.cs.height)},finish:function(){var a=this.drawer.bg_info;this.cs={x:a.x,y:a.y,width:a.width,height:a.height}}},b.inherit(a._SizeCommand,a._Command)}(Diigo.UndoRedo,Diigo.$),function(a,b){a._DoodleColorCommand=function(a,b,c){this.doodle=a,this.ps=b,this.cs=c},a._DoodleColorCommand.prototype={undo:function(){this.doodle.setColor(this.ps)},redo:function(){this.doodle.setColor(this.cs)}},b.inherit(a._DoodleColorCommand,a._Command),a._DoodleWidthCommand=function(a,b,c){this.doodle=a,this.ps=b,this.cs=c},a._DoodleWidthCommand.prototype={undo:function(){this.doodle.setPenWidth(this.ps)},redo:function(){this.doodle.setPenWidth(this.cs)}},b.inherit(a._DoodleWidthCommand,a._Command),a._DoodleNewCommand=function(a){this.doodle=a},a._DoodleNewCommand.prototype={undo:function(){this.doodle.drawer._removeDoodle(this.doodle)},redo:function(){this.doodle.drawer._ur_insert(this.doodle)}},b.inherit(a._DoodleNewCommand,a._Command),a._DoodleDelCommand=function(a){this.doodle=a},a._DoodleDelCommand.prototype={undo:function(){this.doodle.drawer._ur_insert(this.doodle)},redo:function(){this.doodle.drawer._removeDoodle(this.doodle)},toString:function(){return"doodle-command"}},b.inherit(a._DoodleDelCommand,a._Command),a._DoodlePointsCommand=function(a,c,d){this.doodle=a,this.ps=c?c:b.copyPoints(a.points),this.cs=d?d:b.copyPoints(this.ps)},a._DoodlePointsCommand.prototype={undo:function(){b.setPoints(this.doodle.points,this.ps),this.doodle.afterUndoRedo()},redo:function(){b.setPoints(this.doodle.points,this.cs),this.doodle.afterUndoRedo()},finish:function(){b.setPoints(this.cs,this.doodle.points)}},b.inherit(a._DoodlePointsCommand,a._Command),a._DoodleMatrixCommand=function(a,c,d){this.doodle=a,this.ps=c?c:b.copyArray(a.matrix),this.cs=d?d:b.copyArray(this.ps)},a._DoodleMatrixCommand.prototype={undo:function(){b.setArray(this.doodle.matrix,this.ps),this.doodle.afterUndoRedo()},redo:function(){b.setArray(this.doodle.matrix,this.cs),this.doodle.afterUndoRedo()},finish:function(){b.setArray(this.cs,this.doodle.matrix)}},b.inherit(a._DoodleMatrixCommand,a._Command)}(Diigo.UndoRedo,Diigo.$),function(a,b,c){function d(a,b){var d=c.str2rgba(a);return d.a=b,"rgba("+d.r+","+d.g+","+d.b+","+d.a+")"}c.extend(a._Drawer.prototype,{_check_region_mouse_down:function(a){var b=this.__pre_mouse_enter_region__;return null!==b?(b.onMouseDown(a),this.__tmp_undo_command__=b.doodle.getRegionUndoCommand(b),!0):!1},_pointChooseDoodle:function(a){var b=this.page.doodle_array,d=this.c_ctx.getImageData(a.ox,a.oy,1,1),e=d.data;if(e[3]<10)return null;var f=c.color2int(e);return f===b.length?this.cut_doodle?this.cut_doodle:null:f>=0&&b[f]?b[f]:null},_getEventPoint:function(a){null===this.out_pos&&(this.out_pos=c.getDomPosition(this.out_container));var b={x:a.pageX,y:a.pageY},d=this.zoom_scale,e=this.bg_info;return b.sx=b.x,b.sy=b.y,b.cx=b.x-this.out_pos.left,b.cy=b.y-this.out_pos.top,b.ox=b.cx-this.container.offsetLeft+this.out_container.scrollLeft,b.oy=b.cy-this.container.offsetTop+this.out_container.scrollTop,b.x=Math.floor(b.ox/d+e.x),b.y=Math.floor(b.oy/d+e.y),b},_mouse_up_handler:function(a){if(this.__left_mouse_db_down__)return this._mouse_double_down(),this.__left_mouse_db_down__=!1,void(this.__left_mouse_down__=!1);if(this.__left_mouse_down__){this.__left_mouse_down__=!1;var b=this._getEventPoint(a);this._mouse_up(b),this._select_back(),c.delMouseEvent(window,this.__saved_handler.mouse_move),c.delMouseEvent(window,this.__saved_handler.mouse_up),c.stopEvent(a)}},_check_region_mouse_in_out:function(a){function b(a,b,c){for(var d=0;d<a.edit_regions.length;d++)if(a.edit_regions[d].isPointIn(b,c))return a.edit_regions[d];return null}var c=this.__pre_mouse_enter_region__,d=null,e=this.page.doodle_array;if(this.has_selected_doodle){if(null!==this.cut_doodle)d=b(this.cut_doodle,a,this.zoom_scale);else if(d=b(this.edit_doodle,a,this.zoom_scale),null===d)for(var f=0;f<e.length;f++){var g=b(e[f],a,this.zoom_scale);if(null!==g){d=g;break}}d!==c&&(null!==c&&(c.onMouseOut(),this._paintEditLayer()),null!==d?(d.onMouseIn(),this.setCursor_name(d.cursor),this._paintEditLayer()):2===this.cursor_type?this.setCursor(this.default_cursor):this.setCursor_name(this.default_cursor),this.__pre_mouse_enter_region__=d)}},_mouse_move_handler:function(a){if(this.__left_mouse_down__){var b=this._getEventPoint(a),d=this.__pre_mouse_enter_region__;null!==d?(d.onMouseMove(b),this._adjust_scroll(b.x,b.y),this._paintEditLayer()):c.getPTPRange(this.__mouse_down_point__,b)>10&&this._mouse_move(b),c.stopEvent(a)}},_region_handler:function(b){var c=this._getEventPoint(b);if(!this.__left_mouse_down__&&(this._check_region_mouse_in_out(c),null===this.__pre_mouse_enter_region__)){var d=this._pointChooseDoodle(c);null!==d&&this.style.brush_type!==a.Type.RECT_BLUR&&d.type===a.Type.RECT_BLUR&&(d=null),null!==d&&this.__hover_doodle__!==d?(this.__hover_doodle__=d,this.setCursor_name("cursor_move")):null===d&&null!==this.__hover_doodle__&&(this.__hover_doodle__=null,2===this.cursor_type?this.setCursor(this.default_cursor):this.setCursor_name(this.default_cursor))}},_mouse_down_handler:function(a){if(!this.__left_mouse_down__&&0===a.button){this.__left_mouse_down__=!0,this.__left_mouse_db_down__=!1;var b=this._getEventPoint(a);this.__mouse_down_point__=b,1===this.__mouse_down_time__&&c.getPTPRange(this.__pre_point__,b)<10?(this.__mouse_down_time__=0,null!==this.__mdt_timeout__&&(window.clearTimeout(this.__mdt_timeout__),this.__mdt_timeout__=null),this.__left_mouse_db_down__=!0):(this.__pre_point__=b,this.__mouse_down_time__++,this.__mdt_timeout__=window.setTimeout(this.__mdt_delegate__,450),this._mouse_down(b)),this.__saved_handler.mouse_move=c.addMouseEvent(window,"mousemove",this.__cmv_handler),this.__saved_handler.mouse_up=c.addMouseEvent(window,"mouseup",this.__cmu_handler),c.stopEvent(a)}},initEvent:function(){this.__left_mouse_down__=!1,this.__left_mouse_db_down__=!1,this.__draw_point__=!1,this.__hover_doodle__=null,this.__cmv_handler=c.createDelegate(this,this._mouse_move_handler),this.__cmu_handler=c.createDelegate(this,this._mouse_up_handler),this.__saved_handler={mouse_move:null,mouse_up:null},this.__mouse_down_time__=0,this.__mdt_timeout__=null,this.__mdt_delegate__=c.createDelegate(this,function(){this.__mouse_down_time__=0,this.__mdt_timeout__=null,this.__left_mouse_db_down__=!1}),c.addMouseEvent(this.edit_canvas,"mousedown",c.createDelegate(this,this._mouse_down_handler)),c.addEvent(this.edit_canvas,"mousemove",c.createDelegate(this,this._region_handler)),this.__pre_point__={x:0,y:0},this.$list_input.attr({min:1,max:999999}).on("mousedown",function(a){a.stopPropagation()}).on("keypress",function(a){(a.keyCode<47||a.keyCode>58)&&a.preventDefault()}).on("input",c.createDelegate(this,this._list_input_handler)).data("doodle",null),c.addEvent(window,"resize",c.createDelegate(this,this._on_resize))},_on_resize:function(){var a=this.out_container.offsetHeight,b=this.container.offsetHeight;this.container.style.top=a>b+40?"40px":"0px"},_list_input_handler:function(){var a=this.$list_input.data("doodle"),b=Number(this.$list_input.val());(1>b||b>999999)&&(b=this.$list_input.data("pre_value")),a.set_i_value(b)},_show_list_dialog:function(a){var b=this.$list_input,c=this.$list_dialog,d=b.data("doodle");b.data("doodle",a),b.data("pre_value",a.i_value),b.val(a.i_value);var e=a.boundary,f=this.bg_info.x,g=this.bg_info.y,h=this.zoom_scale,i=Math.round((e.left+(e.width-c.innerWidth()/h)/2-f)*h),j=Math.round((e.bottom-g)*h)+15;null===d?c.css({left:i,top:j}).fadeIn(200,function(){b.focus()}):c.animate({left:i,top:j},200)},_hide_list_dialog:function(){null!==this.$list_input.data("doodle")&&(this.$list_dialog.hide(),this.$list_input.data("doodle",null)),this.style_callback("mousedown")},hideListDialog:function(){null!==this.$list_input.data("doodle")&&(this.$list_dialog.hide(),this.$list_input.data("doodle",null))},_mouse_double_down:function(){var b=this.__hover_doodle__;if(null!==b){var c=a.Type;b.type===c.LIST?this._show_list_dialog(b):b.type===c.TEXT?(this.cur_textbox=b,this.activeTextbox()):b.type===c.CALLOUT&&(this.cur_textbox=b.child_textbox,this.activeInnerTextbox())}},_mouse_down:function(b){function c(){for(var a=0;a<g.length;a++)if(g[a].selected)return g[a];return null}this._hide_list_dialog();var d=a.Type,e=this.style.brush_type;if(!this._check_region_mouse_down(b)){var f=null,g=this.page.doodle_array;if(null===this.cur_textbox||(this.unactiveTextbox(),this.paint(),e!==d.CALLOUT&&e!==d.TEXT)){this.temp_doodle=null;var h=this.has_selected_doodle?c():null,i=this.__hover_doodle__;if(null===i&&e===d.LIST&&null===h){var j=a.create(d.LIST,{points:[this.__pre_point__],drawer:this});this.insertDoodle(j),this.default_cursor=a._ListDoodle.__LAST_INFO__.getCursor(),this.setCursor_name("cursor_move"),this.__hover_doodle__=j,i=j}else null===i&&e===d.TEXT&&null===h&&(this.temp_doodle=a.create(d.TEXT,{points:[this.__pre_point__],drawer:this}));if(null!==i){for(var k=0;k<g.length;k++)g[k].selected===!0&&(f=g[k]),g[k].selected=!1,g[k].setRegionDisabled(!0);i.selected=!0,this.has_selected_doodle=!0,this.edit_doodle.attachDoodle(i),this.edit_doodle.editStart(b),null!==this.cut_doodle?this.cut_doodle.editStart():(this.__tmp_undo_command__=i.getMoveUndoCommand(),i.editStart()),this._paintDoodleLayer(),this._paintEditLayer(),i.type!==d.RECT_BLUR||null!==f&&f.type===d.RECT_BLUR||this._prepare_for_blur()}else null===this.temp_doodle&&(this.__draw_point__=this.style.brush_type===d.CURVE&&this.has_selected_doodle===!1?!0:!1,this._select_nothing(),this.edit_doodle.attachNothing(),this._paintDoodleLayer())}}},_move_doodle_to_top:function(a){var b=this.page.doodle_array,c=b.indexOf(a);c>=0&&(b.splice(c,1),b.unshift(a))},_mouse_up:function(b){var e=this.__pre_mouse_enter_region__,f=a.Type,g=a._ListDoodle.__LAST_INFO__;if(null!==e)return e.onMouseUp(b),e.is_changed&&(null!==this.__tmp_undo_command__&&(this.__tmp_undo_command__.finish(),this.history.add(this.__tmp_undo_command__),this.__tmp_undo_command__=null),this.paint()),void(this.__pre_mouse_enter_region__=null);var h=this.__hover_doodle__;if(null!==h)return this.edit_doodle.editFinish(b),h.editFinish(),this._move_doodle_to_top(h),null!==this.__tmp_undo_command__&&c.getPTPRange(this.__pre_point__,b)>10&&(this.__tmp_undo_command__.finish(),this.history.add(this.__tmp_undo_command__)),this.__tmp_undo_command__=null,null!==this.cut_doodle&&this.cut_doodle.editFinish(),void(h.type===f.RECT_BLUR?(this._finish_for_blur(),this.paint()):h.type===f.LIST?(g.radius.a=h.radius.a,g.radius.b=h.radius.b,this.paint()):this.paint());if(this.cut_mode)return this.cut_doodle=this.temp_doodle,this.temp_doodle=null,this.cut_doodle.selected=!0,this.has_selected_doodle=!0,this.edit_doodle.attachDoodle(this.cut_doodle),void this.paint();var i=this.temp_doodle;if(null===i){var j=this.style;return this.__draw_point__&&(i=a.create(f.CURVE,{drawer:this,pen_width:j.pen_width,line_type:j.dot_type|j.arrow_type,color:d(j.color,j.pen_opacity),points:[this.__pre_point__]}),i.initialize(),this.insertDoodle(i)),void this.paint()}i.editFinish();var k=i.type;if(i=this.temp_doodle,k===f.TEXT)i.auto_width=Math.abs(i.points[1].x-i.points[0].x)<30,i.initialize(),this.insertDoodle(i),this.cur_textbox=i,this._select_doodle(i);else if(k===f.CALLOUT)i.initialize(),this.insertDoodle(i),this.cur_textbox=i.child_textbox,this._select_doodle(i);else if(k===f.BEZIER_ARROW)i.initialize(),this.insertDoodle(i),this._select_doodle(i);else if(k===f.IMAGE){var l=i.points;Math.abs(l[0].x-l[1].x)<10&&Math.abs(l[0].x-l[1].x)<10&&i.editPushPoint({x:l[0].x+150,y:l[0].y+150}),i.initialize(),this.insertDoodle(i)}else k!==f.CUT&&(i.initialize(),this.insertDoodle(i),k===f.RECT_BLUR&&this._finish_for_blur());this.temp_doodle=null,this._paintEditLayer(),k===f.TEXT?this.activeTextbox():k===f.CALLOUT?this.activeInnerTextbox():k!==f.CUT&&this.paint()},_adjust_scroll:function(a,b){var c=this.out_container,d=c.scrollLeft,e=c.scrollTop,f=c.offsetWidth,g=c.offsetHeight,h=this.bg_info,i=this.zoom_scale,j=30,k=Math.floor((b-j-h.y)*i),l=k-e,m=Math.floor((b+j-h.y)*i),n=m-e,o=Math.floor((a-h.x-j)*i)-j,p=o-d,q=Math.floor((a+j-h.x)*i),r=q-d;0>l?c.scrollTop=Math.max(0,k):n>g&&(c.scrollTop=Math.min(m-g,Math.floor(h.height*i-g))),0>p?c.scrollLeft=Math.max(0,o):r>f&&(c.scrollLeft=Math.min(Math.floor(h.width*i-f),q-f))},_mouse_move:function(b){var c=this.__hover_doodle__;if(null!==c){var e=this.edit_doodle.editMove(b);return c.editMove(e.x,e.y),null!==this.cut_doodle&&this.cut_doodle.editMove(e.x,e.y),this._adjust_scroll(b.x,b.y),void this._paintEditLayer()}if(null===this.temp_doodle){var f=this.style,g=f.brush_type,h=this.__pre_point__;null!==this.cut_doodle&&(this.cut_doodle=null),g===a.Type.TEXT||g===a.Type.LIST||(g===a.Type.IMAGE?this.temp_doodle=a.create(g,{drawer:this,image:this.style.svg_image,points:[h,b]}):(this.temp_doodle=a.create(g,{drawer:this,pen_width:f.pen_width,line_type:f.dot_type|f.arrow_type,color:d(f.color,f.pen_opacity),points:[h,b]}),g===a.Type.RECT_BLUR&&this._prepare_for_blur()))}else this.temp_doodle.editPushPoint(b),this._adjust_scroll(b.x,b.y);this._paintEditLayer()}})}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b,c){a._EditDoodle=function(b){this.base(a.Type.EDITHELPER,{drawer:b,points:[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],color:"rgba(123,123,123,0.5)"}),this.pre_points=c.copyPoints(this.points),this.selected_doodle=null,this.center={x:0,y:0},this.pre_point={x:0,y:0},this.inter_point={x:0,y:0},this.edit_regions.push(new a.TipRegion(this,0,this.points[4])),this.tip_region=this.edit_regions[0],this.tip_region.disabled=!0,this.__tmp_undo_command__=null},a._EditDoodle.prototype={getRegionUndoCommand:function(){return this.__tmp_undo_command__},onRegionEdit:function(a,b){if(0===a){var c=this.editRotateScale(b);this.selected_doodle.editRotateScale(this.center,c.rotate,c.scale),this._set_rotate_point()}},onRegionEditStart:function(a,b){var c=this.selected_doodle;this.__tmp_undo_command__=c.getRotateUndoCommand(),c.editStart(b),this.pre_point.x=b.x,this.pre_point.y=b.y,this.inter_point.x=b.x,this.inter_point.y=b.y},onRegionEditFinish:function(){this.selected_doodle.editFinish(),null!==this.__tmp_undo_command__&&(this.__tmp_undo_command__.finish(),this.drawer.history.add(this.__tmp_undo_command__),this.__tmp_undo_command__=null),this._calc(),this._set_rotate_point()},attachDoodle:function(a){var b=this.points,c=a.boundary;b[0].x=c.left,b[0].y=c.top,b[1].x=c.right,b[1].y=c.top,b[2].x=c.right,b[2].y=c.bottom,b[3].x=c.left,b[3].y=c.bottom,a.setRegionDisabled(!1),this.selected_doodle=a,this._calc(),this._set_rotate_point()},_re_attach_doodle:function(){null!==this.selected_doodle&&this.attachDoodle(this.selected_doodle)},_set_rotate_point:function(){if(null!==this.selected_doodle){var a=this.selected_doodle.getRotatePoint();null!==a?(this.points[4].x=a.x,this.points[4].y=a.y,this.tip_region.disabled=!1):this.tip_region.disabled=!0}},attachNothing:function(){this.selected_doodle=null,this.tip_region.disabled=!0},_calc:function(){var a=this.points;this.center.x=Math.floor((a[0].x+a[2].x)/2),this.center.y=Math.floor((a[0].y+a[2].y)/2)},editStart:function(a){c.setPoints(this.pre_points,this.points),this._calc(),this.pre_point.x=a.x,this.pre_point.y=a.y},editMove:function(a){for(var b={x:a.x-this.pre_point.x,y:a.y-this.pre_point.y},c=0;c<this.points.length;c++)this.points[c].x=this.pre_points[c].x+b.x,this.points[c].y=this.pre_points[c].y+b.y;return b},_editFinish:function(){this._calc(),this.drawer.onChange()},editFinish:function(a){return this._editFinish(),{x:a.x-this.pre_point.x,y:a.y-this.pre_point.y}},editRotateScale:function(a){return this._calcRSValue(a)},_calcRSValue:function(a){var b=a.x-this.center.x,c=a.y-this.center.y,d=this.pre_point.x-this.center.x,e=this.pre_point.y-this.center.y,f=Math.sqrt(b*b+c*c),g=Math.sqrt(d*d+e*e),h=(b*d+c*e)/(f*g),i=Math.acos(h);return Math.abs(h-1)<=1e-7?i=0:Math.abs(h+1)<=1e-7?i=Math.PI:b*e-d*c>0&&(i=2*Math.PI-i),{scale:f/g,rotate:i}
}},c.inherit(a._EditDoodle,a._Doodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b,c){b.EventRegion=function(a,b,c){this.doodle=a,this.idx=b,this.is_mouse_in=!1,this.is_changed=!1,this.cursor=c?"cursor_"+c:"cursor_pointer",this.disabled=!0},b.EventRegion.prototype={isPointIn:function(){return!1},isPointIn_xy:function(){return!1},onMouseIn:function(){this.is_mouse_in=!0},onMouseOut:function(){this.is_mouse_in=!1},onMouseDown:function(a){this.is_changed=!1,this.doodle.onRegionEditStart(this.idx,a)},onMouseMove:function(a){this.doodle.onRegionEdit(this.idx,a),this.is_changed=!0},onMouseUp:function(a){this.doodle.onRegionEditFinish(this.idx,a)},draw:function(){},editDraw:function(a,b,c){this.doodle.draw_region(a,b,c)}},b.CircleRegion=function(a,b,c,d,e){this.base(a,b,e),this.center=c,this.radius="undefined"==typeof d?7:d},b.CircleRegion.prototype={isPointIn:function(a){return this.disabled?!1:c.getPTPRange(this.center,a)<=this.radius},draw:function(a){a.save(),a.strokeStyle="rgba(0,0,0,0.1)",a.lineWidth=1,a.save(),a.shadowColor="rgba(0,0,0,0.25)",a.shadowBlur=4,a.shadowOffsetX=0,a.shadowOffsetY=2,a.beginPath(),a.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI,!1),a.stroke(),a.closePath(),a.fillStyle="#fff",a.fill(),a.restore();var b=this.center.x-this.radius+2,c=this.center.y-this.radius+2,d=a.createLinearGradient(b,c,b,c+2*(this.radius-2));d.addColorStop(0,"#09f"),d.addColorStop(1,"#07f"),a.fillStyle=d,a.beginPath(),a.arc(this.center.x,this.center.y,this.radius-2,0,2*Math.PI,!1),a.closePath(),a.fill(),a.restore()}},c.inherit(b.CircleRegion,b.EventRegion),b.TipRegion=function(a,b,c){this.base(a,b,c,5,"rotation")},b.TipRegion.prototype={isPointIn:function(a){return this.disabled?!1:c.getPTPRange(this.center,a)<=this.radius},isPointIn_xy:function(a,b){return this.disabled?!1:c.getPTPRange_xy(this.center.x,this.center.y,a,b)<=this.radius},draw:function(a){this.disabled||(a.save(),a.strokeStyle="rgba(0,0,0,0.2)",a.lineWidth=2,a.save(),a.shadowColor="rgba(0,0,0,0.15)",a.shadowBlur=3,a.shadowOffsetX=0,a.shadowOffsetY=1,a.beginPath(),a.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI,!1),a.stroke(),a.closePath(),a.fillStyle="#fff",a.fill(),a.restore(),a.fillStyle="#080",a.beginPath(),a.arc(this.center.x,this.center.y,this.radius-1,0,2*Math.PI,!1),a.closePath(),a.fill(),a.restore())}},c.inherit(b.TipRegion,b.CircleRegion)}(Diigo.Text,Diigo.Doodle,Diigo.$),function(a,b){var c=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],d=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24],e=function(a,b,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=a.data,F=f+f+1,G=b-1,H=e-1,I=f+1,J=I*(I+1)/2,K={r:0,g:0,b:0,a:0,next:null},L=K;for(i=1;F>i;i++)if(L=L.next={r:0,g:0,b:0,a:0,next:null},i==I)var M=L;L.next=K;var N=null,O=null;m=l=0;var P=c[f],Q=d[f];for(h=0;e>h;h++){for(v=w=x=y=n=o=p=q=0,r=I*(z=E[l]),s=I*(A=E[l+1]),t=I*(B=E[l+2]),u=I*(C=E[l+3]),n+=J*z,o+=J*A,p+=J*B,q+=J*C,L=K,i=0;I>i;i++)L.r=z,L.g=A,L.b=B,L.a=C,L=L.next;for(i=1;I>i;i++)j=l+((i>G?G:i)<<2),n+=(L.r=z=E[j])*(D=I-i),o+=(L.g=A=E[j+1])*D,p+=(L.b=B=E[j+2])*D,q+=(L.a=C=E[j+3])*D,v+=z,w+=A,x+=B,y+=C,L=L.next;for(N=K,O=M,g=0;b>g;g++)E[l+3]=C=q*P>>Q,0!=C?(C=255/C,E[l]=(n*P>>Q)*C,E[l+1]=(o*P>>Q)*C,E[l+2]=(p*P>>Q)*C):E[l]=E[l+1]=E[l+2]=0,n-=r,o-=s,p-=t,q-=u,r-=N.r,s-=N.g,t-=N.b,u-=N.a,j=m+((j=g+f+1)<G?j:G)<<2,v+=N.r=E[j],w+=N.g=E[j+1],x+=N.b=E[j+2],y+=N.a=E[j+3],n+=v,o+=w,p+=x,q+=y,N=N.next,r+=z=O.r,s+=A=O.g,t+=B=O.b,u+=C=O.a,v-=z,w-=A,x-=B,y-=C,O=O.next,l+=4;m+=b}for(g=0;b>g;g++){for(w=x=y=v=o=p=q=n=0,l=g<<2,r=I*(z=E[l]),s=I*(A=E[l+1]),t=I*(B=E[l+2]),u=I*(C=E[l+3]),n+=J*z,o+=J*A,p+=J*B,q+=J*C,L=K,i=0;I>i;i++)L.r=z,L.g=A,L.b=B,L.a=C,L=L.next;for(k=b,i=1;f>=i;i++)l=k+g<<2,n+=(L.r=z=E[l])*(D=I-i),o+=(L.g=A=E[l+1])*D,p+=(L.b=B=E[l+2])*D,q+=(L.a=C=E[l+3])*D,v+=z,w+=A,x+=B,y+=C,L=L.next,H>i&&(k+=b);for(l=g,N=K,O=M,h=0;e>h;h++)j=l<<2,E[j+3]=C=q*P>>Q,C>0?(C=255/C,E[j]=(n*P>>Q)*C,E[j+1]=(o*P>>Q)*C,E[j+2]=(p*P>>Q)*C):E[j]=E[j+1]=E[j+2]=0,n-=r,o-=s,p-=t,q-=u,r-=N.r,s-=N.g,t-=N.b,u-=N.a,j=g+((j=h+I)<H?j:H)*b<<2,n+=v+=N.r=E[j],o+=w+=N.g=E[j+1],p+=x+=N.b=E[j+2],q+=y+=N.a=E[j+3],N=N.next,r+=z=O.r,s+=A=O.g,t+=B=O.b,u+=C=O.a,v-=z,w-=A,x-=B,y-=C,O=O.next,l+=b}};b.stackBlurCanvasRGBA=function(a,b,c,d,f,g){var h=a.getImageData(b,c,d,f);e(h,d,f,"undefined"==typeof g?7:g),a.putImageData(h,b,c)}}(Diigo.Doodle,Diigo.$),function(a,b,c,d){a._Editor=function(b){this.parent=b,this.history=b.history,this.auto_width=!1,this.textarea=b.textarea,this.textarea_out=b.textarea_out,this.floated_textbox=null,this.RTL=b.RTL,this.cur_page=null,this.pages=[],this.render=new a._Render(this),this.initEvent(),this.focused=!1,this.saved_info={cur_page:null,width:0,height:0,scale:1}},a._Editor.prototype={onChange:function(){},paint:function(){this.render.paint()},_paint:function(){this.render._paint()},getPageByIdx:function(a){return this.pages[a]},setBoxAutoWidth:function(a){this.auto_width=a},setBoxSize_scale:function(a,b,c){var d=Math.floor(a*c),e=Math.floor(b*c);this.textarea.style.width=d+"px",this.textarea.style.height=e+"px",this.render.width=a,this.render.height=b,this.render.scale=c},save_state:function(){var a=this.saved_info;a.scale=this.render.scale,a.width=this.render.width,a.height=this.render.height,a.cur_page=this.cur_page},set_drawtext_size:function(a,b,c){this.render.width=a,this.render.height=b,this.render.scale=c},restore_state:function(){var a=this.saved_info;this.render.scale=a.scale,this.render.width=a.width,this.render.height=a.height,this.cur_page=a.cur_page,this.render.page=a.cur_page;var b=Math.floor(a.width*a.scale),c=Math.floor(a.height*a.scale);this.textarea.style.width=b+"px",this.textarea.style.height=c+"px"},getPageHeight:function(a){return this.pages[a].page_height},setBoxMatrix:function(a){var b="matrix("+a[0]+","+a[3]+","+a[1]+","+a[4]+","+a[2]+","+a[5]+")";this.textarea.style.webkitTransform=b},setBoxPosition:function(a,b,c){this.textarea_out.style.left=a+"px",this.textarea_out.style.top=b+"px",this.textarea.style.webkitTransform="rotate("+Math.round(180*c/Math.PI)+"deg)"},createPage:function(b){var c=new a._Page(this,b);return this.pages.push(c),this.pages.length-1},setCurPage:function(a,b){this.cur_page=this.pages[a],this.render.page=this.cur_page,this.render.m_auto_width=b?!0:!1;var c=this.cur_page.style.getScaleFont(this.parent.zoom_scale);this.textarea.style.font=c,this.textarea.style.lineHeight=d.getFontInfo(c).height+"px",this.textarea.style.color=this.cur_page.style.color,this.textarea.value=this.cur_page.text},_setCurPage:function(a){this.cur_page=this.pages[a],this.render.page=this.cur_page},_setCurPage_saved:function(a){var b=this.pages.indexOf(this.cur_page);return this._setCurPage(a),b},focus:function(){this.focused===!1&&(this.focused=!0,this.textarea.focus())},blur:function(){this.focused&&(this.focused=!1,this.textarea.blur())},clear:function(){this.cur_page.reset(),this.select_doodle=null,this._setCaret({index:-1,para:0,para_at:-1,left:0,top:0}),this.history.clear()},show:function(){this.textarea.style.display="block"},hide:function(){this.textarea.style.display="none"}}}(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(a,b,c,d,e){e.extend(a._Editor.prototype,{_text_handler:function(){this.floated_textbox.onTextInput(this.textarea.value)},_keypress_handler:function(){this.floated_textbox.onTextPress()},initEvent:function(){e.addEvent(this.textarea,"input",e.createDelegate(this,this._text_handler)),e.addEvent(this.textarea,"keypress",e.createDelegate(this,this._keypress_handler))}})}(Diigo.Text,Diigo.Doodle,Diigo.Data,Diigo.UndoRedo,Diigo.$),function(a,b){a._Paragraph=function(b,c,d,e,f,g,h){this.index=b,this.length=c,this.line_start=d,this.line_cross=e,this.lines=h?h:[new a._Line],this.rtl=f?!0:!1,this.align=g?g:a._Paragraph.Align.LEFT},a._Paragraph.Align={LEFT:0,RIGHT:1,MIDDLE:2},a._Line=function(a,b,c){this.end_index=a?a:-1,this.unti_dir=b?b:[],this.width=c?c:0},a._Element=function(a){this.value=a,this.width=0,this.visible=!0},a._Page=function(a,c){this.editor=a,this.style=c,this.text="",this.ele_array=[],this.para_number=0,this.para_info=[],this.line_number=0,this.page_height=0;var d=b.getFontInfo(c.font);this.line_height=d.height,this.baseline_offset=d.baseline_offset,this._init()},a._Page.prototype={resetFont:function(){var a=b.getFontInfo(this.style.font);this.line_height=a.height,this.baseline_offset=a.baseline_offset},_init:function(){this.para_number=1,this.para_info=[new a._Paragraph(-1,0,0,1,!1,a._Paragraph.Align.LEFT)],this.line_number=1,this.page_height=this.line_number*this.line_height,this.text="",this.ele_array.length=0},reset:function(){this._init()},initParagraph:function(){var b=-1,c=0,d=new a._Paragraph(b,0,c,1);this.ele_array.length=this.text.length;var e;for(e=0;e<this.text.length;e++)this.ele_array[e]=new a._Element(this.text[e]);for(this.para_number=1,this.para_info=[],this.line_number=0,this.para_info.push(d),e=0;e<this.ele_array.length;e++)"\n"===this.ele_array[e].value&&(d.length=e-b-1,d.line_cross=this._measureParagraph(d),c+=d.line_cross,this.line_number+=d.line_cross,b=e,d=new a._Paragraph(b,0,c,1),this.para_info.push(d),this.para_number++);d.length=this.ele_array.length-1-b,d.line_cross=this._measureParagraph(d),this.line_number+=d.line_cross,this.page_height=this.line_number*this.line_height},_measureParagraph:function(a){return a.rtl=this._getParaRTL(a),this.editor.render._measure(a,this.style)},_getParaRTL:function(b){var c=!1,d=0;if(b.length>0)for(var e=b.index+1;e<b.index+1+b.length;e++)if(d=this.text.charCodeAt(e),d>=0&&!a.Char.isBiaoDian(d)&&!a.Char.isDigit(d)){c=!0;break}return c?a.Char.isRTL(d):!1}}}(Diigo.Text,Diigo.$),function(a){a._Style=function(a){a=a?a:{},this.color=a.color?a.color:"#000000",this.background=a.background?a.background:!1,this.underline=a.underline?a.underline:!1,this.through=a.through?a.through:!1,this.bold=a.bold?a.bold:!1,this.italic=a.italic?a.italic:!1,this.font_name=a.font_name?a.font_name:"Arial",this.font_size=a.font_size?a.font_size:16,this.font=this._getFont()},a._Style.prototype={setFontName:function(a){this.font_name=a,this.font=this._getFont()},setFontSize:function(a){this.font_size=a,this.font=this._getFont()},setItalic:function(a){this.italic=a,this.font=this._getFont()},setThrough:function(a){this.through=a},setScale:function(a){this.scale=a,this.font=this._getFont()},setBold:function(a){this.bold=a,this.font=this._getFont()},setStyle:function(a){null!=a.bold?this.bold=a.bold:!1,null!=a.color?this.color=a.color:!1,null!=a.background?this.background=a.background:!1,null!=a.bg_invert?this.bg_invert=a.bg_invert:!1,null!=a.underline?this.underline=a.underline:!1,null!=a.through?this.through=a.through:!1,null!=a.italic?this.italic=a.italic:!1,null!=a.font_name?this.font_name=a.font_name:!1,null!=a.font_size?this.font_size=a.font_size:!1,this.font=this._getFont()},clone:function(){return new a._Style(this)},_getFont:function(){return(this.bold?"bold ":"")+(this.italic?"italic ":"")+this.font_size+"px "+this.font_name},getScaleFont:function(a){return(this.bold?"bold ":"")+(this.italic?"italic ":"")+Math.floor(this.font_size*a)+"px "+this.font_name}}}(Diigo.Text),function(a){a._Render=function(a){this.editor=a,this.page=null,this.width=0,this.height=0,this.scale=1,this.baseline_offset=0,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")},a._Render.prototype={_paintLine:function(a,b,c,d,e,f,g){var h=this.editor.cur_page.text.substr(c+a,b-a+1);this.ctx.fillText(h,g,f)},_paintContent:function(){var b=this.editor,c=this.scale,d=0,e=b.cur_page.line_height,f=b.cur_page.line_height*c,g=this.page.para_info,h=0,i=d/c,j=0,k=0,l=0,m=this.height*c+f;0>=i?(j=0,k=-i+e,l=-d+f):(j=Math.floor(i/e),k=(j+1)*e-i,l=(j+1)*f-d);for(var n=0;n<g.length&&(h+=g[n].lines.length)<=j;)n++;if(!(n>=g.length)){var o=j-(h-g[n].lines.length);a:for(;n<g.length;n++){var p=g[n],q=p.lines,r=0,s=a._Paragraph.Align;o>0&&(r=q[o-1].end_index+1);for(var t=o;t<q.length;t++){var u=0;switch(p.align){case s.LEFT:u=0;break;case s.MIDDLE:u=Math.round((this.width-q[t].width)/2);break;case s.RIGHT:u=this.width-q[t].width}if(this._paintLine(r,q[t].end_index,p.index+1,q[t].unti_dir,p.rtl,k-b.cur_page.baseline_offset,u),r=q[t].end_index+1,k+=e,l+=f,l>=m)break a}o=0}}},paintToContext:function(a,b){var c=this.ctx,d=this.scale;this.ctx=a,this.ctx.save(),this.ctx.scale(d,d),this.ctx.font=b.font,this.ctx.fillStyle=b.color,""!==this.page.text.trim()&&this._paintContent(),this.ctx.restore(),this.ctx=c}}}(Diigo.Text,Diigo.$),function(a,b){a.Char={isRTL:function(a){return a>=1536&&1791>=a},isBiaoDian:function(a){return a>=32&&47>=a||a>=58&&64>=a||a>=91&&96>=a||a>=123&&126>=a},isDigit:function(a){return a>=48&&57>=a},isIdeographic:function(a,b){if(a>=11904&&12287>=a)return!0;if(12288===a)return!0;if(a>=12352&&12447>=a){if(!b)switch(a){case 12353:case 12355:case 12357:case 12359:case 12361:case 12387:case 12419:case 12421:case 12423:case 12430:case 12437:case 12438:case 12443:case 12444:case 12445:case 12446:return!1}return!0}if(a>=12448&&12543>=a){if(!b)switch(a){case 12448:case 12449:case 12451:case 12453:case 12455:case 12457:case 12483:case 12515:case 12517:case 12519:case 12526:case 12533:case 12534:case 12539:case 12540:case 12541:case 12542:return!1}return!0}return a>=13312&&19893>=a?!0:a>=19968&&40891>=a?!0:a>=63744&&64217>=a?!0:a>=40960&&42127>=a?!0:a>=42128&&42191>=a?!0:a>=65122&&65126>=a?!0:a>=65296&&65305>=a?!0:!1}},b.extend(a._Render.prototype,{_getDirLength:function(b,c,d,e){for(var f=!1,g=1,h=c+1,i=0;d>h;){var j=b[h].value.charCodeAt(h),k=e?a.Char.isRTL(j):j>0&&!a.Char.isRTL(j)&&!a.Char.isBiaoDian(j);if(k)f&&(g+=i,f=!1,i=0),g++;else{if(!(0>j||a.Char.isBiaoDian(j)))break;i++,f=!0}h++}return g},_getCode:function(a){return a.value.charCodeAt(0)},_measureStrElement:function(a){return this.ctx.measureText(a).width},_measureElement:function(a){return this.ctx.measureText(a.value).width},_measure:function(b,c){return this.ctx.font=c.font,b.lines=[new a._Line(-1,[],0)],this._doMeasure(b)},_m_LTR:function(b,c,d,e,f,g,h,i){for(var j=e-1,k=b?!0:!1,l=0,m=e,n=b?e+this._getDirLength(d,e,i,!1):i,o=b?c:this.width-c,p=b?e:-1;n>m;){var q=d[m],r=this._getCode(q),s=m===e?null:d[m-1],t=(null===s?-1:this._getCode(s),i>m+1?d[m+1]:null),u=null===t?-1:this._getCode(t);if(!b&&a.Char.isRTL(r)){n=m;break}if(r>=0&&0===q.width&&(q.width=this._measureElement(q)),l+=q.width,o>l)!(0>r||32===r||9===r)&&(44!==r&&46!==r&&58!==r&&59!==r||m!==h&&a.Char.isDigit(this._getCode(d[m-1]))||null!==t&&a.Char.isDigit(u))&&(45!==r&&47!==r||null!==t&&a.Char.isDigit(u))&&!(r>=11904&&a.Char.isIdeographic(r,!0)&&null!==t&&a.Char.isIdeographic(u,!1))||(k=!1,j=m);else{if(32!==r){(j>=e||k)&&(m=j+1);var v=f-g.line_start;if(!k&&b){for(var w={index:p-h,length:m-p,width:0},x=p;m>x;x++)w.width+=d[x].width;g.lines[v].unti_dir.push(w)}g.lines[v].end_index=m-1-h,g.lines.push(new a._Line),l=0,p=m,c=b?this.width:0,o=this.width,l=0,j=e-1,f++,k=!1;continue}q.visible=!1,j=m}m++}return b&&g.lines[f-g.line_start].unti_dir.push({index:p-h,length:n-p,width:l}),{left:b?c-l:c+l,line_at:f,end_index:n}},_calc_line_width:function(a,b,c){for(var d=0,e=b;c>=e;e++)a[e].visible&&(d+=a[e].width);return d},_m_RTL:function(b,c,d,e,f,g,h,i){for(var j=e-1,k=b?!0:!1,l=0,m=e,n=b?this.width-c:c,o=b?e+this._getDirLength(d,e,i,!0):i,p=b?e:-1,q=m,r=0,s="";o>m;){var t=d[m],u=i>m+1?d[m+1]:null,v=this._getCode(t);if(!b&&v>=0&&!a.Char.isRTL(v)&&!a.Char.isBiaoDian(v)){o=m;break}if(v>0?(s+=t.value,r=this._measureStrElement(t,s)):r=t.width,n>l+r){if(1536>v&&(k=!1,j=m),1536>v||null===u||!a.Char.isRTL(this._getCode(u))){if(v>0)for(var w=q;m>=w;w++)d[w].width=r/(m-q+1);l+=r,s="",q=m+1}m++}else{(j>e||k)&&(m=j+1);var x=f-g.line_start;if(!k&&b){for(var y={index:p-h,length:m-p,width:0},z=p;m>z;z++)y.width+=d[z].width;g.lines[x].unti_dir.push(y)}g.lines[x].end_index=m-1-h,g.lines.push(new a._Line),p=m;for(var w=q;m>=w;w++)d[w].width=r/(m-q+1);s="",q=m,c=b?0:this.width,n=this.width,l=0,j=e-1,f++,k=!1}}return b&&g.lines[f-g.line_start].unti_dir.push({index:p-h,length:o-p,width:l}),{left:b?c+l:c-l,line_at:f,end_index:o}},_doMeasure:function(a){for(var b=a.rtl,c=a.index+1,d=c+a.length,e=a.line_start,f=this.page.ele_array,g=b?this.width:0,h=c,i=null;d>h;)i=b?this._m_RTL(a.rtl===!1,g,f,h,e,a,c,d):this._m_LTR(a.rtl===!0,g,f,h,e,a,c,d),e=i.line_at,g=i.left,h=i.end_index,b=!b;a.lines[e-a.line_start].end_index=a.length-1;for(var h=0;h<a.lines.length;h++){var j=this._calc_line_width(f,a.index+1+(0===h?0:a.lines[h-1].end_index),a.index+1+a.lines[h].end_index);a.lines[h].width=j}return e-a.line_start+1}})}(Diigo.Text,Diigo.$);